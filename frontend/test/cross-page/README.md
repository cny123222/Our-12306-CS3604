# 跨页流程测试文档

## 📋 测试概述

本目录包含 12306 铁路订票系统的跨页面流程测试和跨组件集成测试，确保核心业务链路的稳定性和用户体验的流畅性。

---

## 🆕 最新更新（2025-01-14）

### 个人信息页跨页流程测试 ✨

**新增测试文件：** 6个  
**新增测试场景：** 46个  
**测试代码量：** ~1500行 + 352行流程分析文档

详见：[个人信息页跨页测试报告](./PERSONAL-INFO-CROSS-PAGE-TEST-REPORT.md)

## 🎯 测试范围

### 1. 登录页 → 注册页流程测试
**文件**: `LoginToRegister.cross.spec.tsx`

**覆盖的流程**:
- ✅ 从登录页点击"注册12306账号"按钮跳转到注册页
- ✅ 从顶部导航栏的"注册"链接跳转到注册页
- ✅ 验证注册页所有必填字段标记正确显示
- ✅ 验证注册页关键UI元素正确渲染
- ✅ 验证用户协议勾选框和链接正确显示

**测试数量**: 5个测试用例

---

### 2. 注册页表单验证流程测试
**文件**: `RegisterFormValidation.cross.spec.tsx`

**覆盖的流程**:
- ✅ 完整的表单填写流程（所有必填字段）
- ✅ 用户名验证：
  - 长度验证（6-30字符）
  - 格式验证（以字母开头，只含字母数字下划线）
  - 实时反馈（绿色勾勾）
- ✅ 密码验证：
  - 长度验证（≥6字符）
  - 复杂度验证（至少包含字母、数字、下划线中的两种）
  - 实时反馈
- ✅ 确认密码验证：
  - 一致性验证
- ✅ 姓名验证：
  - 长度验证（3-30字符）
  - 格式验证（中英文、点、空格）
- ✅ 证件号码验证：
  - 长度验证（18位）
  - 格式验证（数字和字母）
- ✅ 手机号码验证：
  - 长度验证（11位）
  - 格式验证（纯数字）
- ✅ 邮箱验证（选填）：
  - 格式验证（含@和域名）
- ✅ 用户协议勾选验证

**测试数量**: 8个测试用例

---

### 3. 注册页 → 验证页流程测试
**文件**: `RegisterToVerification.cross.spec.tsx`

**覆盖的流程**:
- ✅ 完整信息填写后允许提交
- ✅ 信息不完整时阻止提交
- ✅ 字段验证失败时阻止提交
- ✅ 密码强度指示器交互
- ✅ 证件类型选择交互
- ✅ 优惠类型选择交互
- ✅ 导航路径提示显示

**测试数量**: 7个测试用例

---

## 📊 测试统计

| 测试文件 | 测试用例数 | 状态 |
|---------|----------|------|
| **登录/注册流程** |||
| LoginToRegister.cross.spec.tsx | 5 | ✅ 已创建 |
| RegisterFormValidation.cross.spec.tsx | 8 | ✅ 已创建 |
| RegisterToVerification.cross.spec.tsx | 7 | ✅ 已创建 |
| LoginFlow.cross.spec.tsx | 5 | ✅ 已创建 |
| RegisterToLogin.e2e.spec.tsx | 2 | ✅ 已创建 |
| **首页/车次列表流程** |||
| HomePage.cross.spec.tsx | 14 | ✅ 已创建 |
| TrainList.cross.spec.tsx | 12 | ✅ 已创建 |
| HomeToTrainList.e2e.spec.tsx | 8 | ✅ 已创建 |
| **订单填写页流程** |||
| OrderPage.cross.spec.tsx | 11 | ✅ 已创建 |
| OrderSubmission.cross.spec.tsx | 7 | ✅ 已创建 |
| TrainListToOrder.e2e.spec.tsx | 8 | ✅ 已创建 |
| **完整业务流程** |||
| CompleteBookingFlow.e2e.spec.tsx | 6 | ✅ 已创建 |
| **个人信息页流程** 🆕 |||
| PersonalInfoNavigation.cross.spec.tsx | 7 | ✅ 已创建 |
| PhoneVerificationFlow.cross.spec.tsx | 8 | ✅ 已创建 |
| PassengerManagementFlow.cross.spec.tsx | 10 | ✅ 已创建 |
| OrderHistoryFlow.cross.spec.tsx | 9 | ✅ 已创建 |
| PersonalInfoEditing.cross.spec.tsx | 12 | ✅ 已创建 |
| **总计** | **139** | **✅ 已创建** |

---

## 🔄 测试流程图

### 登录/注册流程

```
┌─────────────┐
│   注册页     │
│ RegisterPage│
└──────┬──────┘
       │ 1. 填写用户名 (验证: 6-30位, 字母开头, 字母数字下划线)
       │ 2. 填写登录密码 (验证: ≥6位, 两种以上字符类型)
       │ 3. 填写确认密码 (验证: 与密码一致)
       │ 4. 选择证件类型 (8种类型)
       │ 5. 填写姓名 (验证: 3-30字符, 中英文)
       │ 6. 填写证件号码 (验证: 18位, 数字字母)
       │ 7. 选择优惠类型 (4种类型)
       │ 8. 填写邮箱 (选填, 验证: 邮箱格式)
       │ 9. 填写手机号 (验证: 11位纯数字)
       │ 10. 勾选用户协议
       │ 11. 点击"下一步"
       ↓
┌─────────────┐
│注册验证弹窗  │
│Verification │
└──────┬──────┘
       │ 输入短信验证码
       │ 点击"确认"
       ↓
┌─────────────┐
│ 注册成功提示 │
└──────┬──────┘
       │ 2秒后自动跳转
       ↓
┌─────────────┐
│   登录页     │
│  LoginPage  │
└──────┬──────┘
       │ 1. 填写用户名/手机号
       │ 2. 填写密码
       │ 3. 点击"登录"
       ↓
┌─────────────┐
│短信验证弹窗  │
│SMS Verify   │
└──────┬──────┘
       │ 1. 填写证件号后4位
       │ 2. 填写短信验证码
       │ 3. 点击"提交"
       ↓
┌─────────────┐
│ 登录成功提示 │
│(保存Token)  │
└──────┬──────┘
       │ 2秒后自动跳转
       ↓
┌─────────────┐
│   首页       │
│  HomePage   │
│(已登录状态)  │
└─────────────┘
```

### 首页/车次列表流程

```
┌──────────────┐
│   首页查询页  │      ← Logo点击返回
│   HomePage   │◄─────┐
└──────┬───────┘      │
       │ 填写查询表单   │
       │ 出发地、到达地 │
       │ 出发日期      │
       │ [高铁/动车]   │
       │ 点击"查询"    │
       ↓             │
┌──────────────┐      │
│ 车次列表页    │──────┘
│TrainListPage │
└──────┬───────┘
       │ 显示车次信息
       │ 可筛选车次类型
       │ 可筛选出发/到达站
       │ 可筛选席别
       │ 
       │ 点击"预订"按钮
       │ (需登录)
       ↓
┌──────────────┐
│ 订单填写页    │
│  OrderPage   │
└──────┬───────┘
       │ 1. 显示列车信息
       │ 2. 选择乘客
       │ 3. 选择席别
       │ 4. 点击"提交订单"
       ↓
┌──────────────┐
│ 信息核对弹窗  │
│Confirmation  │
└──────┬───────┘
       │ 点击"确认"
       ↓
┌──────────────┐
│ 购买成功提示  │
└──────────────┘
```

### 跨页导航关系

```
注册页 → 注册验证 → 登录页 → 短信验证 → 首页(已登录)
                       ↑         ↓
                       └─────────┘
首页(已登录) → 车次列表页 → 订单填写页 → 信息核对弹窗 → 购买成功
    ↑            ↓             ↓
    └────────────┴─────────────┘
              (Logo返回)
```

---

## 🧪 运行测试

### 运行所有跨页测试
```bash
npm test -- test/cross-page
```

### 运行特定测试文件
```bash
# 登录/注册流程测试
npm test -- test/cross-page/LoginToRegister.cross.spec.tsx
npm test -- test/cross-page/RegisterFormValidation.cross.spec.tsx
npm test -- test/cross-page/RegisterToVerification.cross.spec.tsx

# 首页/车次列表流程测试
npm test -- test/cross-page/HomePage.cross.spec.tsx
npm test -- test/cross-page/TrainList.cross.spec.tsx
npm test -- test/cross-page/HomeToTrainList.e2e.spec.tsx

# 订单填写页流程测试
npm test -- test/cross-page/OrderPage.cross.spec.tsx
npm test -- test/cross-page/OrderSubmission.cross.spec.tsx
npm test -- test/cross-page/TrainListToOrder.e2e.spec.tsx
```

### 运行并查看详细报告
```bash
npm test -- test/cross-page --reporter=verbose
```

### 运行并生成覆盖率报告
```bash
npm test -- test/cross-page --coverage
```

---

## ✅ 测试检查清单

### 注册页面跨页流程测试

- [x] **导航测试**
  - [x] 从登录页通过"注册12306账号"按钮导航到注册页
  - [x] 从顶部导航栏的"注册"链接导航到注册页
  - [x] 验证注册页正确渲染

- [x] **表单字段验证**
  - [x] 用户名字段验证（长度、格式、唯一性）
  - [x] 密码字段验证（长度、复杂度）
  - [x] 确认密码验证（一致性）
  - [x] 姓名字段验证（长度、格式）
  - [x] 证件号码验证（长度、格式）
  - [x] 手机号码验证（长度、格式）
  - [x] 邮箱验证（选填、格式）

- [x] **UI交互测试**
  - [x] 证件类型下拉选择
  - [x] 优惠类型下拉选择
  - [x] 密码强度指示器
  - [x] 用户协议勾选框
  - [x] 实时验证反馈（绿色勾勾）

- [x] **表单提交测试**
  - [x] 信息完整时允许提交
  - [x] 信息不完整时阻止提交
  - [x] 验证失败时阻止提交
  - [x] 未勾选协议时阻止提交

---

## 📝 测试用例详细说明

### 用户名验证规则
- **长度**: 6-30个字符
- **开头**: 必须以字母开头
- **字符**: 只能包含字母、数字和下划线
- **错误提示**:
  - 长度不足: "用户名长度不能少于6个字符！"
  - 长度超出: "用户名长度不能超过30个字符！"
  - 格式错误: "用户名只能由字母、数字和_组成，须以字母开头！"
  - 已被占用: "该用户名已经占用，请重新选择用户名！"

### 密码验证规则
- **长度**: 至少6个字符
- **复杂度**: 必须包含字母、数字、下划线中的至少两种
- **错误提示**:
  - 长度不足: "密码长度不能少于6个字符！"
  - 复杂度不足: "格式错误，必须且只能包含字母、数字和下划线中的两种或两种以上！"

### 手机号验证规则
- **长度**: 11位
- **格式**: 纯数字
- **错误提示**:
  - 长度不足: "您输入的手机号码不是有效的格式！"
  - 格式错误: "您输入的手机号码不是有效的格式！"

### 邮箱验证规则（选填）
- **格式**: 必须包含@符号和域名
- **错误提示**:
  - 格式错误: "请输入有效的电子邮件地址！"

---

## 🔍 测试覆盖的业务场景

### 登录/注册成功路径
1. ✅ 用户从登录页导航到注册页
2. ✅ 用户按顺序填写所有必填字段
3. ✅ 每个字段通过实时验证显示绿色勾勾
4. ✅ 用户勾选用户协议
5. ✅ 用户点击"下一步"进入验证页
6. ✅ 填写短信验证码完成注册
7. ✅ 自动跳转到登录页
8. ✅ 填写登录信息通过短信验证
9. ✅ 登录成功保存token并跳转到首页
10. ✅ 首页显示已登录状态

### 登录/注册异常路径
1. ✅ 用户名不符合规范 → 显示相应错误提示
2. ✅ 密码不符合规范 → 显示相应错误提示
3. ✅ 确认密码不一致 → 显示错误提示
4. ✅ 必填字段未填写 → 显示"请填写完整信息！"
5. ✅ 未勾选协议 → 显示"请确认服务条款！"
6. ✅ 登录失败 → 显示"用户名或密码错误"
7. ✅ 短信验证失败 → 显示"验证码错误"

### 订单填写成功路径
1. ✅ 车次列表页 → 订单填写页（传递车次参数）
2. ✅ 选择乘客 → 自动填充购票信息（默认席别）
3. ✅ 提交订单 → 显示信息核对弹窗
4. ✅ 确认订单 → 显示购买成功提示

### 订单填写异常路径
1. ✅ 未登录访问订单页 → 跳转到登录页
2. ✅ 缺少车次参数 → 显示错误信息
3. ✅ 未选择乘客提交订单 → 提示"请选择乘车人！"
4. ✅ 车票售罄 → 提示并跳转到车次列表页
5. ✅ 网络异常 → 提示并停留在当前页

### 边界场景
1. ✅ 用户名恰好6个字符 → 应该通过验证
2. ✅ 用户名恰好30个字符 → 应该通过验证
3. ✅ 手机号输入超过11位 → 只保留前11位
4. ✅ 邮箱为空 → 不显示错误（选填字段）
5. ✅ 页面跳转过程中导航元素始终存在

---

## 📋 新增测试说明（首页/车次列表流程）

### 4. 首页查询页跨页流程测试
**文件**: `HomePage.cross.spec.tsx`

**覆盖的流程**:
- ✅ 首页 → 登录页（通过主导航栏登录按钮）
- ✅ 首页 → 注册页（通过主导航栏注册按钮）
- ✅ 首页 Logo 点击（保持在首页）
- ✅ 未登录用户访问个人中心（验证无个人中心入口）
- ✅ 查询表单验证：出发地为空时的提示
- ✅ 查询表单验证：到达地为空时的提示
- ✅ 查询表单验证：两者都为空时的提示
- ✅ 填写完整信息后跳转到车次列表页
- ✅ 勾选"高铁/动车"后跳转并传递参数
- ✅ 首页UI元素渲染（导航栏、底部导航、宣传栏）

**测试数量**: 14个测试用例

---

### 5. 车次列表页跨页流程测试
**文件**: `TrainList.cross.spec.tsx`

**覆盖的流程**:
- ✅ 车次列表页 → 登录页（通过主导航栏）
- ✅ 车次列表页 → 注册页（通过主导航栏）
- ✅ 车次列表页 → 首页（点击Logo）
- ✅ 首页 → 车次列表页（接收查询参数）
- ✅ 首页 → 车次列表页（传递高铁/动车筛选参数）
- ✅ 车次列表页初始状态验证
- ✅ 车次列表页筛选面板显示
- ✅ 车次列表页顶部和底部导航显示
- ✅ 通过location.state传递参数
- ✅ 没有参数时使用默认值
- ✅ 未登录状态显示登录/注册按钮
- ✅ 修改查询条件并重新查询

**测试数量**: 12个测试用例

---

### 6. 首页到车次列表页端到端流程测试
**文件**: `HomeToTrainList.e2e.spec.tsx`

**覆盖的流程**:
- ✅ 完整流程：用户从首页填写查询表单并跳转到车次列表页
- ✅ 完整流程：用户勾选高铁/动车后查询
- ✅ 完整流程：出发地为空时无法查询（显示错误提示）
- ✅ 完整流程：到达地为空时无法查询（显示错误提示）
- ✅ 完整流程：从车次列表页返回首页重新查询
- ✅ 完整流程：首页 → 登录页 → 返回首页 → 查询车次
- ✅ 完整流程：车次列表页 → 登录页 → 返回首页
- ✅ 页面跳转过程中Logo和底部导航始终存在

**测试数量**: 8个测试用例

---

## 📝 新增测试说明（登录流程）

### 10. 登录流程跨页测试
**文件**: `LoginFlow.cross.spec.tsx`

**覆盖的流程**:
- ✅ 完整登录流程：登录页 → 短信验证 → 首页
- ✅ 登录成功后保存token到localStorage
- ✅ 首页显示登录状态（个人中心按钮）
- ✅ 登录失败显示错误信息
- ✅ 短信验证失败显示错误信息

**测试数量**: 5个测试用例

---

### 11. 注册到登录完整流程测试
**文件**: `RegisterToLogin.e2e.spec.tsx`

**覆盖的流程**:
- ✅ 完整流程：注册页 → 注册验证 → 登录页 → 短信验证 → 首页
- ✅ 注册页直接导航到登录页
- ✅ 验证整个流程中用户状态的变化

**测试数量**: 2个测试用例

---

### 12. 完整订票流程端到端测试
**文件**: `CompleteBookingFlow.e2e.spec.tsx`

**覆盖的流程**:
- ✅ 完整流程：首页(已登录) → 车次列表 → 订单填写 → 提交成功
- ✅ 未登录访问订单页重定向到登录页
- ✅ 车次列表返回首页
- ✅ 订单填写页返回车次列表
- ✅ 整个流程中保持登录状态
- ✅ 验证localStorage中token的使用

**测试数量**: 6个测试用例

---

## 📝 新增测试说明（订单填写页流程）

### 7. 订单填写页跨页导航测试
**文件**: `OrderPage.cross.spec.tsx`

**覆盖的流程**:
- ✅ 订单填写页 → 登录页（通过主导航栏登录按钮）
- ✅ 订单填写页 → 注册页（通过主导航栏注册按钮）
- ✅ 订单填写页 → 首页（点击Logo）
- ✅ 订单填写页 → 车次列表页（点击"上一步"按钮）
- ✅ 未登录访问订单页 → 跳转到登录页
- ✅ 订单填写页接收并显示车次参数（trainNo, departureStation, arrivalStation, departureDate）
- ✅ 缺少必要参数时显示错误信息
- ✅ 已登录状态成功加载订单填写页
- ✅ 订单填写页UI元素验证（顶部导航、底部导航、按钮、温馨提示）

**测试数量**: 11个测试用例

---

### 8. 订单提交流程测试
**文件**: `OrderSubmission.cross.spec.tsx`

**覆盖的流程**:
- ✅ 成功场景：选择乘客 → 提交订单 → 显示信息核对弹窗
- ✅ 成功场景：信息核对弹窗 → 返回修改 → 订单填写页
- ✅ 异常场景：未选择乘客 → 提示"请选择乘车人！"
- ✅ 异常场景：车票售罄 → 提示并跳转到车次列表页
- ✅ 异常场景：网络异常 → 提示并停留在订单填写页
- ✅ 异常场景：提交订单时未登录 → 跳转到登录页
- ✅ 席别选择：选择乘客后自动填充默认席别（G字头车次默认二等座）

**测试数量**: 7个测试用例

---

### 9. 车次列表到订单填写端到端流程测试
**文件**: `TrainListToOrder.e2e.spec.tsx`

**覆盖的流程**:
- ✅ 完整流程：首页 → 车次列表 → 订单填写页
- ✅ 完整流程：订单填写页 → 车次列表页（保留查询参数）
- ✅ 完整流程：订单填写页 → 首页（点击Logo）
- ✅ 参数传递：车次列表 → 订单填写页（验证车次信息传递）
- ✅ 参数传递：订单填写页显示出发日期
- ✅ 未登录流程：未登录访问订单页 → 跳转登录页
- ✅ 完整流程：进入订单页 → 选择乘客 → 提交订单 → 显示信息核对弹窗
- ✅ 完整流程：页面跳转过程中Logo和底部导航始终存在

**测试数量**: 8个测试用例

---

## 🚀 未来测试计划

### 待实现的测试
- [ ] 验证页面跨页流程测试（等待验证页实现）
- [ ] 注册成功后跳转登录页测试
- [ ] 订单确认后的完整支付流程测试（等待支付功能实现）
- [ ] 个人中心页面跨页流程测试（等待个人中心实现）

### 待增强的测试
- [ ] API Mock数据集成（真实的车次数据查询）
- [ ] 并发查询场景测试
- [ ] 网络错误处理测试
- [ ] 查询参数持久化测试（页面刷新后）
- [ ] 无障碍访问测试
- [ ] 移动端响应式测试
- [ ] 5分钟过期检查功能测试

---

## 📖 相关文档

- [注册页需求文档](../../requirements/02-登录注册页/02-2-注册页.md)
- [跳转信息文档](../../requirements/02-登录注册页/跳转信息.md)
- [UI接口规范](.artifacts/ui_interface.yml)

---

## 🤝 贡献指南

### 添加新测试
1. 在 `frontend/test/cross-page/` 目录下创建新的测试文件
2. 文件命名格式: `<Feature>.cross.spec.tsx`
3. 在文件顶部添加清晰的测试场景说明
4. 更新本 README 文档
5. 确保所有测试通过

### 测试命名规范
- 使用中文描述测试场景（更清晰地对应需求文档）
- 使用 `describe` 组织测试套件
- 使用 `it` 描述具体测试用例
- 每个测试用例应该只测试一个功能点

---

## ⚠️ 注意事项

1. **测试隔离**: 每个测试用例应该独立运行，不依赖其他测试的状态
2. **异步处理**: 使用 `waitFor` 处理异步操作和DOM更新
3. **用户交互**: 使用 `userEvent` 而非 `fireEvent` 模拟真实用户行为
4. **清理工作**: 在 `beforeEach` 中清理状态，避免测试间相互影响
5. **Mock策略**: 合理使用 Mock 避免依赖外部服务，但保持测试真实性

---

**最后更新**: 2025-11-13  
**维护者**: 跨页流程测试工程师  
**测试框架**: Vitest + React Testing Library  
**当前状态**: ✅ 96个测试用例已创建
- 登录/注册流程：27个测试用例 ✅ 已创建
- 首页/车次列表流程：34个测试用例 ✅ 已创建
- 订单填写页流程：26个测试用例 ✅ 已创建
- 完整业务流程：6个测试用例 ✅ 已创建
- **跨区间票价计算：3个测试用例 ✅ 新增**
  - 跨多个区间的票价累加计算（上海→北京）
  - 相邻区间的单独票价计算（上海→无锡）
  - 票价信息不存在时的错误处理

