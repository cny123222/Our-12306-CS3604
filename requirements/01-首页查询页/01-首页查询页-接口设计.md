# 01-首页/查询页 接口设计

目的：为首页/查询页的站点选择、日期选择、车次查询及登录/注册/个人中心跳转提供统一的API契约，支撑前后端协作与测试。

统一约定
- 传输协议：HTTPS；
- 编码：UTF-8，JSON；
- 鉴权：登录态接口采用 Bearer Token；未登录接口可匿名；
- 错误返回：{"code":"ERROR_CODE","message":"人类可读提示","details":{...}}；
- 成功返回：{"code":"OK","data":{...}}；
- 时间：均采用服务器时区或UTC，前端展示按本地时区；
- 性能指标：关键查询接口目标响应≤100ms（不含网络波动）；失败策略按需求执行。

1) 站点相关
- GET /api/stations
  - 描述：站点列表与搜索；支持中文/拼音/别名模糊匹配。
  - Query：
    - query (string, optional)：搜索关键字；为空时返回全部（可分页）。
    - limit (int, optional, default 50)
    - offset (int, optional, default 0)
  - Response data：
    - stations: [{station_id, station_name_cn, station_name_py, alias_list[], station_code}]
  - Errors：VALIDATION_ERROR（非法参数），INTERNAL_ERROR

- GET /api/stations/recommend
  - 描述：根据输入内容推荐相似站点。
  - Query：
    - input (string, required)
    - limit (int, optional, default 10)
  - Response data：
    - recommendations: [{station_id, station_name_cn, station_name_py, similarity (0..1)}]
  - Errors：STATION_NOT_FOUND（无推荐时返回空数组但不报错）、INTERNAL_ERROR

2) 日期与放票
- GET /api/calendar/release-dates
  - 描述：返回可售日期集合（已放票的日期）。
  - Query：
    - from (date, optional)：起始日期；
    - to (date, optional)：结束日期；若均为空，返回系统默认范围（如接下来N天）。
  - Response data：
    - dates: ["YYYY-MM-DD", ...]
  - Errors：INTERNAL_ERROR

3) 车次查询
- GET /api/trains
  - 描述：根据出发地、到达地、日期与筛选项返回车次列表。
  - Query：
    - from_station_code (string, required)
    - to_station_code (string, required)
    - date (string, required, YYYY-MM-DD)
    - filters (object, optional)：如 {student: bool, high_speed: bool, emu: bool}
  - Response data：
    - trains: [
      {
        train_no, train_type, from_station_code, to_station_code,
        departure_time, arrival_time, duration,
        seats: [{type: "二等/一等/商务/硬座/硬卧/软卧", available: int}],
        price_range: {min: number, max: number}
      }
    ]
  - Errors：
    - VALIDATION_ERROR（站点或日期不合法）
    - NO_TICKETS（无符合条件车次，返回空列表即可）
    - INTERNAL_ERROR（查询失败）

4) 认证与用户中心
- POST /api/auth/login
  - Body：{username: string, password: string}
  - Response data：{token: string, user: {user_id, nickname}}
  - Errors：AUTH_INVALID（账号或密码错误）、INTERNAL_ERROR

- POST /api/auth/register
  - Body：{username: string, password: string, phone?: string, sms_code?: string}
  - Response data：{user_id, nickname}
  - Errors：USER_EXISTS、VALIDATION_ERROR、INTERNAL_ERROR

- GET /api/users/me
  - Headers：Authorization: Bearer <token>
  - Response data：{user_id, nickname, phone?, email?}
  - Errors：AUTH_REQUIRED、INTERNAL_ERROR

5) 错误码与文案映射（前端界面文案遵循需求原文）
- VALIDATION_ERROR → “无法匹配该出发地/到达地”或对应字段校验提示
- AUTH_INVALID → “登录失败，请稍后重试”（具体账号错误可细化）
- AUTH_REQUIRED → “请先登录12306账号！”
- INTERNAL_ERROR → “查询失败，请稍后重试”或“前往个人中心失败，请稍后重试”等场景提示
- USER_EXISTS → “注册失败，请稍后重试”（可细化为“用户已存在”视具体文案策略）

6) 示例
- 示例：GET /api/stations?query=shang&limit=10
  - 返回：{"code":"OK","data":{"stations":[{"station_id":"3100","station_name_cn":"上海","station_name_py":"shanghai","alias_list":["沪"],"station_code":"SHH"}]}}

- 示例：GET /api/trains?from_station_code=HZH&to_station_code=SHH&date=2025-12-01&filters={"high_speed":true}
  - 返回（省略字段）：{"code":"OK","data":{"trains":[{"train_no":"G1234","train_type":"G","departure_time":"08:00","arrival_time":"09:15","duration":"01:15","seats":[{"type":"二等","available":23}],"price_range":{"min":128,"max":456}}]}}

7) 接口校验与防护（建议）
- 输入白/黑名单：站点编码校验、日期格式校验、过滤非法字符；
- 速率限制：防止暴力请求；
- 异常保护：统一错误处理中间件；
- 可观测性：关键接口打点与耗时记录，用于满足100ms体验要求的追踪。

附：关联文档
- 《01-首页查询页-需求拆解》
- 《01-首页查询页-测试用例》