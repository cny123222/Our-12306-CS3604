# 测试购买流程指南

## 🎯 完整测试步骤

### 前提条件
1. ✅ 后端服务器运行中（http://localhost:3000）
2. ✅ 前端服务器运行中（http://localhost:5173）
3. ✅ 已清除浏览器缓存

### 测试流程

#### 步骤1：访问系统
打开浏览器访问：`http://localhost:5173`

**强制刷新**（清除缓存）：
- Mac: `Command + Shift + R`
- Windows: `Ctrl + Shift + R`

#### 步骤2：登录
使用测试账号登录（如果还没登录的话）

#### 步骤3：搜索车次
- 出发地：上海
- 目的地：北京
- 出发日期：2025-11-13（或任何可用日期）
- 点击"查询"

**预期结果**：看到车次列表，包括D6

#### 步骤4：选择车次
点击D6车次的"预订"按钮

**预期结果**：进入订单填写页

#### 步骤5：选择乘客
在乘客列表中勾选一个乘客（例如：刘嘉敏）

**预期结果**：乘客被选中，下方显示购票信息

#### 步骤6：提交订单
点击"提交订单"按钮

**预期结果**：显示"信息核对弹窗"，包含：
- 车次信息
- 乘客信息表格
- 余票信息
- "返回修改"和"确认"按钮

#### 步骤7：确认订单
点击橙色"确认"按钮

**预期结果**：依次显示：

1. **处理中弹窗**（短暂）
   - 提示："订单已经提交，系统正在处理中，请稍等"

2. **购买成功弹窗**（重点！）
   ```
   ┌──────────────────────────────┐
   │      ✓ (绿色图标)            │
   │      购买成功                │
   │  恭喜您，订单已确认！        │
   │  您的车票信息如下：          │
   │                              │
   │  🎫 车次信息                 │
   │  日期    2025-11-13（周四）  │
   │  车次    D6次                │
   │  行程    上海站 → 北京站      │
   │                              │
   │  🎫 车票信息                 │
   │  ┌────┬────┬────┬────┐      │
   │  │乘客│席别│座位号│票种│      │
   │  ├────┼────┼────┼────┤      │
   │  │刘嘉敏│二等座│05车06A号│成人票│ │
   │  └────┴────┴────┴────┘      │
   │                              │
   │  订单号：order-xxxx          │
   │                              │
   │     [ 确认 ] (橙色按钮)      │
   └──────────────────────────────┘
   ```

3. **点击"确认"**
   - 关闭弹窗
   - 返回首页（http://localhost:5173/）

## ⚠️ 常见问题

### 问题1：点击"确认"后直接返回订单填写页

**症状**：没有看到"购买成功"弹窗

**原因**：
- 浏览器缓存了旧代码
- API调用失败
- Token无效

**解决方案**：
1. 强制刷新浏览器（Command/Ctrl + Shift + R）
2. 清除LocalStorage：
   ```javascript
   localStorage.clear();
   location.reload();
   ```
3. 重新登录
4. 检查浏览器控制台是否有错误

### 问题2：看到"订单确认失败"

**可能原因**：
- Token无效 → 重新登录
- 订单不存在 → 创建新订单
- 订单已确认 → 创建新订单
- 座位已售罄 → 选择其他车次

### 问题3：API返回401错误

**原因**：Token过期

**解决方案**：
```javascript
// 在浏览器控制台执行
localStorage.clear();
location.reload();
```
然后重新登录

## 🔍 调试方法

### 方法1：浏览器开发者工具

1. 打开开发者工具（F12）
2. 切换到**Console**标签
3. 进行购买操作
4. 查看是否有错误信息

### 方法2：Network监控

1. 打开开发者工具（F12）
2. 切换到**Network**标签
3. 点击"确认"按钮
4. 查找 `confirm` 请求
5. 检查：
   - Status: 应该是 `200`
   - Response: 应该包含 `trainInfo` 和 `tickets`

### 方法3：添加调试日志

在浏览器控制台执行：

```javascript
// 监控所有fetch请求
const originalFetch = window.fetch;
window.fetch = function(...args) {
  console.log('🔵 API请求:', args[0], args[1]);
  return originalFetch(...args).then(response => {
    console.log('🟢 API响应:', response.status, response.url);
    return response;
  }).catch(error => {
    console.error('🔴 API错误:', error);
    throw error;
  });
};
```

然后再次执行购买流程，控制台会显示所有API调用。

## ✅ 验证清单

测试完成后，请确认以下所有项：

- [ ] 能够搜索到车次
- [ ] 能够选择车次并进入订单填写页
- [ ] 能够选择乘客
- [ ] 能够提交订单
- [ ] 能够看到信息核对弹窗
- [ ] 点击"确认"后看到"处理中"提示
- [ ] **能够看到"购买成功"弹窗**
- [ ] **弹窗显示车次信息**
- [ ] **弹窗显示车票信息表格**
- [ ] **座位号用橙色背景高亮**
- [ ] **有橙色"确认"按钮**
- [ ] 点击"确认"返回首页

## 📞 需要帮助？

如果测试失败，请提供：

1. **浏览器控制台截图**（包含错误信息）
2. **Network标签中的API请求详情**
3. **具体的操作步骤和现象描述**

我会立即帮您解决！

---

**最后更新**: 2025-11-13
**系统版本**: Our-12306-CS3604

