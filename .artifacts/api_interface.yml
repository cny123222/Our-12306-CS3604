# 后端API接口定义
# 基于登录页、注册页、首页查询页和车次列表页需求文档生成

- type: Backend
  id: API-POST-Login
  route: POST /api/auth/login
  description: 处理用户登录请求，支持用户名/邮箱/手机号登录
  input:
    type: JSON
    body:
      identifier: string  # 用户名/邮箱/手机号
      password: string
  output:
    success:
      statusCode: 200
      body: 
        message: "登录验证通过，需要短信验证"
        requireSmsVerification: true
        sessionId: "uuid"
    error:
      - statusCode: 400
        body: { error: "请输入用户名！" }
      - statusCode: 400
        body: { error: "请输入密码！" }
      - statusCode: 400
        body: { error: "密码长度不能少于6位！" }
      - statusCode: 401
        body: { error: "用户名或密码错误！" }
  dependencies:
    - DB-FindUserByUsername
    - DB-FindUserByEmail
    - DB-FindUserByPhone
    - DB-VerifyPassword
  acceptanceCriteria:
    - 验证输入字段的完整性和格式
    - 支持用户名、邮箱、手机号三种登录方式
    - 密码验证失败时清空密码字段（前端处理）
    - 验证成功后返回会话ID，准备进入短信验证流程
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持多种方式登录验证。"

- type: Backend
  id: API-POST-SendVerificationCode
  route: POST /api/auth/send-verification-code
  description: 发送短信验证码
  input:
    type: JSON
    body:
      sessionId: string
      idCardLast4: string  # 证件号后4位
  output:
    success:
      statusCode: 200
      body: { message: "获取短信验证码成功！" }
    error:
      - statusCode: 400
        body: { error: "请输入正确的用户信息！" }
      - statusCode: 429
        body: { error: "请求验证码过于频繁，请稍后再试！" }
      - statusCode: 401
        body: { error: "会话无效或已过期" }
  dependencies:
    - DB-FindUserByUsername
    - DB-FindUserByEmail
    - DB-FindUserByPhone
    - DB-CreateVerificationCode
    - DB-CheckVerificationCodeFrequency
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 验证证件号后4位是否与用户信息匹配
    - 检查发送频率限制（1分钟内只能发送一次）
    - 成功发送后启动60秒倒计时
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持短信验证码发送功能。"

- type: Backend
  id: API-POST-VerifyLogin
  route: POST /api/auth/verify-login
  description: 验证短信验证码并完成登录
  input:
    type: JSON
    body:
      sessionId: string
      idCardLast4: string
      verificationCode: string
  output:
    success:
      statusCode: 200
      body: 
        message: "登录成功"
        token: "jwt_token"
        userId: "uuid"
        redirectUrl: "/personal-center"
    error:
      - statusCode: 400
        body: { error: "请输入登录账号绑定的证件号后4位" }
      - statusCode: 400
        body: { error: "请输入验证码" }
      - statusCode: 400
        body: { error: "请输入正确的验证码" }
      - statusCode: 400
        body: { error: "验证码校验失败！" }
      - statusCode: 401
        body: { error: "很抱歉，您输入的短信验证码有误。" }
      - statusCode: 401
        body: { error: "会话无效或已过期" }
  dependencies:
    - DB-VerifyCode
    - DB-UpdateUserLoginStatus
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 验证证件号后4位不能为空
    - 验证码必须为6位数字
    - 验证码必须正确且未过期
    - 验证成功后生成JWT token并更新用户登录状态
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持短信验证码验证和登录完成。"

- type: Backend
  id: API-GET-HomePage
  route: GET /api/home
  description: 获取12306首页内容
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body: 
        pageContent: "object"
        banners: "array"
        announcements: "array"
  dependencies:
    - none
  acceptanceCriteria:
    - 返回首页所需的基本内容
    - 支持Logo点击跳转功能
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持Logo跳转到首页功能。"

- type: Backend
  id: API-GET-ForgotPassword
  route: GET /api/auth/forgot-password
  description: 获取忘记密码页面
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body: 
        pageContent: "object"
        resetOptions: "array"
  dependencies:
    - none
  acceptanceCriteria:
    - 返回忘记密码页面内容
    - 提供密码重置选项
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持忘记密码页面跳转。"

- type: Backend
  id: API-POST-ValidateUsername
  route: POST /api/register/validate-username
  description: 验证用户名的合法性和可用性
  input:
    type: JSON
    body:
      username: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "用户名可用" }
    error:
      - statusCode: 400
        body: { valid: false, error: "用户名长度不能少于6个字符！" }
      - statusCode: 400
        body: { valid: false, error: "用户名长度不能超过30个字符！" }
      - statusCode: 400
        body: { valid: false, error: "用户名只能由字母、数字和_组成，须以字母开头！" }
      - statusCode: 409
        body: { valid: false, error: "该用户名已经占用，请重新选择用户名！" }
  dependencies:
    - DB-FindUserByUsername
  acceptanceCriteria:
    - 验证用户名长度在6-30个字符之间
    - 验证用户名以字母开头
    - 验证用户名只包含字母、数字和下划线
    - 验证用户名在数据库中的唯一性
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页用户名实时验证。"

- type: Backend
  id: API-POST-ValidatePassword
  route: POST /api/register/validate-password
  description: 验证密码的合法性
  input:
    type: JSON
    body:
      password: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "密码格式正确" }
    error:
      - statusCode: 400
        body: { valid: false, error: "密码长度不能少于6个字符！" }
      - statusCode: 400
        body: { valid: false, error: "格式错误，必须且只能包含字母、数字和下划线中的两种或两种以上！" }
  dependencies:
    - none
  acceptanceCriteria:
    - 验证密码长度大于等于6位
    - 验证密码只包含字母、数字和下划线
    - 验证密码必须包含字母、数字、下划线中的至少两种
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页密码格式验证。"

- type: Backend
  id: API-POST-ValidateName
  route: POST /api/register/validate-name
  description: 验证姓名的合法性
  input:
    type: JSON
    body:
      name: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "姓名格式正确" }
    error:
      - statusCode: 400
        body: { valid: false, error: "允许输入的字符串在3-30个字符之间！" }
      - statusCode: 400
        body: { valid: false, error: "请输入姓名！" }
  dependencies:
    - none
  acceptanceCriteria:
    - 验证姓名长度在3-30个字符之间（1个汉字算2个字符）
    - 验证姓名只包含中英文字符、"."和单空格
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页姓名格式验证。"

- type: Backend
  id: API-POST-ValidateIdCard
  route: POST /api/register/validate-idcard
  description: 验证证件号码的合法性和可用性
  input:
    type: JSON
    body:
      idCardType: string
      idCardNumber: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "证件号码格式正确且可用" }
    error:
      - statusCode: 400
        body: { valid: false, error: "请正确输入18位证件号码！" }
      - statusCode: 400
        body: { valid: false, error: "输入的证件编号中包含中文信息或特殊字符！" }
      - statusCode: 409
        body: { valid: false, error: "该证件号码已经被注册过，请确认是否您本人注册，"是"请使用原账号登录，"不是"请通过铁路12306App办理抢注或持该证件到就近的办理客运业务的铁路车站办理被抢注处理，完成后即可继续注册，或致电12306客服咨询。" }
  dependencies:
    - DB-FindUserByIdCardNumber
  acceptanceCriteria:
    - 验证证件号码长度为18个字符
    - 验证证件号码只包含数字和字母
    - 验证证件号码在数据库中的唯一性
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页证件号码验证。"

- type: Backend
  id: API-POST-ValidateEmail
  route: POST /api/register/validate-email
  description: 验证邮箱格式的合法性
  input:
    type: JSON
    body:
      email: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "邮箱格式正确" }
    error:
      - statusCode: 400
        body: { valid: false, error: "请输入有效的电子邮件地址！" }
  dependencies:
    - none
  acceptanceCriteria:
    - 验证邮箱包含"@"符号
    - 验证邮箱包含有效域名
    - 使用标准邮箱格式验证规则
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页邮箱格式验证。"

- type: Backend
  id: API-POST-ValidatePhone
  route: POST /api/register/validate-phone
  description: 验证手机号码的合法性
  input:
    type: JSON
    body:
      phone: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "手机号码格式正确" }
    error:
      - statusCode: 400
        body: { valid: false, error: "您输入的手机号码不是有效的格式！" }
      - statusCode: 400
        body: { valid: false, error: "您输入的手机号码不是有效的格式！" }
  dependencies:
    - none
  acceptanceCriteria:
    - 验证手机号码长度为11位
    - 验证手机号码只包含数字
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页手机号码格式验证。"

- type: Backend
  id: API-POST-Register
  route: POST /api/register
  description: 处理用户注册请求，创建新用户账户
  input:
    type: JSON
    body:
      username: string
      password: string
      confirmPassword: string
      idCardType: string
      name: string
      idCardNumber: string
      discountType: string
      email: string  # 可选
      phone: string
      agreedToTerms: boolean
  output:
    success:
      statusCode: 201
      body: { message: "注册信息已提交，请进行验证", sessionId: "uuid" }
    error:
      - statusCode: 400
        body: { error: "请填写完整信息！" }
      - statusCode: 400
        body: { error: "确认密码与密码不一致！" }
      - statusCode: 400
        body: { error: "请确认服务条款！" }
      - statusCode: 400
        body: { error: "请修正填写的信息！" }
      - statusCode: 409
        body: { error: "该用户名已经占用，请重新选择用户名！" }
      - statusCode: 409
        body: { error: "该证件号码已经被注册过" }
  dependencies:
    - DB-FindUserByUsername
    - DB-FindUserByIdCardNumber
    - DB-FindUserByPhone
    - DB-CreateVerificationCode
    - DB-CreateEmailVerificationCode
  acceptanceCriteria:
    - 验证所有必填字段完整性
    - 验证密码和确认密码一致性
    - 验证用户协议已勾选
    - 验证用户名、证件号码、手机号的唯一性
    - 创建用户会话并返回sessionId用于后续验证
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持用户注册功能。"

- type: Backend
  id: API-POST-SendRegistrationVerificationCode
  route: POST /api/register/send-verification-code
  description: 发送注册验证码（短信和邮箱）
  input:
    type: JSON
    body:
      sessionId: string
      phone: string
      email: string  # 可选
  output:
    success:
      statusCode: 200
      body: { message: "验证码发送成功" }
    error:
      - statusCode: 400
        body: { error: "会话无效或已过期" }
      - statusCode: 429
        body: { error: "请求验证码过于频繁，请稍后再试！" }
  dependencies:
    - DB-CreateVerificationCode
    - DB-CreateEmailVerificationCode
    - DB-CheckVerificationCodeFrequency
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 发送短信验证码到用户手机
    - 如果提供了邮箱，同时发送邮箱验证码
    - 检查发送频率限制
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册验证码发送功能。"

- type: Backend
  id: API-POST-CompleteRegistration
  route: POST /api/register/complete
  description: 验证验证码并完成用户注册
  input:
    type: JSON
    body:
      sessionId: string
      smsCode: string
      emailCode: string  # 可选
  output:
    success:
      statusCode: 201
      body: { message: "恭喜您注册成功，请到登录页面进行登录！" }
    error:
      - statusCode: 400
        body: { error: "验证码错误或已过期" }
      - statusCode: 400
        body: { error: "会话无效或已过期" }
      - statusCode: 500
        body: { error: "注册失败，请稍后重试" }
  dependencies:
    - DB-VerifyCode
    - DB-VerifyEmailCode
    - DB-CreateUser
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 验证短信验证码
    - 如果提供了邮箱验证码，同时验证邮箱验证码
    - 验证通过后创建用户记录
    - 清理临时会话数据
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册验证和用户创建功能。"

- type: Backend
  id: API-GET-ServiceTerms
  route: GET /api/terms/service-terms
  description: 获取《中国铁路客户服务中心网站服务条款》内容
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body: 
        title: "服务条款"
        content: "string"
  dependencies:
    - none
  acceptanceCriteria:
    - 返回服务条款的完整内容
    - 支持页面跳转和文本显示
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持服务条款页面访问。"

- type: Backend
  id: API-GET-PrivacyPolicy
  route: GET /api/terms/privacy-policy
  description: 获取《隐私权政策》内容
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body: 
        title: "隐私权政策"
        englishTitle: "NOTICE"
        content: "string"
  dependencies:
    - none
  acceptanceCriteria:
    - 返回隐私权政策的完整内容
    - 支持中英文标题显示
    - 支持页面跳转和文本显示
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持隐私权政策页面访问。"

# === 首页查询页和车次列表页相关API接口 ===

- type: Backend
  id: API-GET-Stations
  route: GET /api/stations
  description: 获取所有可用站点列表
  input:
    type: Query
    params:
      keyword: string  # 可选，用于站点搜索
  output:
    success:
      statusCode: 200
      body:
        stations: "array"  # [{ name: string, code: string, pinyin: string }]
    error:
      - statusCode: 500
        body: { error: "获取站点列表失败" }
  dependencies:
    - DB-GetAllStations
    - DB-SearchStations
  acceptanceCriteria:
    - 如果未提供keyword，返回所有站点列表
    - 如果提供keyword，返回模糊匹配的站点列表
    - 支持按简拼、全拼、汉字搜索
    - 用于出发地和到达地的下拉推荐
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持站点查询和推荐功能。"

- type: Backend
  id: API-POST-SearchTrains
  route: POST /api/trains/search
  description: 搜索符合条件的车次列表
  input:
    type: JSON
    body:
      departureStation: string
      arrivalStation: string
      departureDate: string  # YYYY-MM-DD格式
      trainTypes: array  # 可选，如 ["G", "C", "D"]
  output:
    success:
      statusCode: 200
      body:
        trains: "array"  # 车次列表
        timestamp: "string"  # 查询时间戳，用于检测5分钟过期
    error:
      - statusCode: 400
        body: { error: "请选择出发地" }
      - statusCode: 400
        body: { error: "请选择到达地" }
      - statusCode: 400
        body: { error: "无法匹配该出发地" }
      - statusCode: 400
        body: { error: "无法匹配该到达地" }
      - statusCode: 500
        body: { error: "查询失败，请稍后重试" }
  dependencies:
    - DB-SearchTrains
    - DB-GetAllStations
  acceptanceCriteria:
    - 验证出发地和到达地不为空
    - 验证出发地和到达地在系统支持的站点列表中
    - 出发日期默认为当前日期
    - 支持按车次类型筛选（高铁/动车）
    - 在100毫秒内返回查询结果
    - 仅返回直达车次，不包含换乘
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持车次查询功能。"

- type: Backend
  id: API-GET-TrainDetails
  route: GET /api/trains/:trainNo
  description: 获取指定车次的详细信息
  input:
    type: Path
    params:
      trainNo: string
  output:
    success:
      statusCode: 200
      body:
        trainNo: string
        trainType: string
        model: string
        route: object
        stops: array
        cars: array
        fares: object
        availableSeats: object
    error:
      - statusCode: 404
        body: { error: "车次不存在" }
      - statusCode: 500
        body: { error: "获取车次详情失败" }
  dependencies:
    - DB-GetTrainDetails
    - DB-GetTrainStops
    - DB-CalculateAvailableSeats
  acceptanceCriteria:
    - 返回车次的完整信息
    - 包含所有停靠站点和时刻表
    - 包含车厢配置和席别信息
    - 包含票价和余票信息
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持车次详情查询。"

- type: Backend
  id: API-POST-CalculateAvailableSeats
  route: POST /api/trains/available-seats
  description: 计算指定车次在指定区间的余票数
  input:
    type: JSON
    body:
      trainNo: string
      departureStation: string
      arrivalStation: string
      departureDate: string
  output:
    success:
      statusCode: 200
      body:
        trainNo: string
        availableSeats: object  # { "商务座": 10, "一等座": 50, "二等座": 100 }
    error:
      - statusCode: 400
        body: { error: "参数错误" }
      - statusCode: 404
        body: { error: "车次不存在" }
      - statusCode: 500
        body: { error: "计算余票失败" }
  dependencies:
    - DB-CalculateAvailableSeats
    - DB-GetSeatStatus
  acceptanceCriteria:
    - 准确计算各席别的余票数
    - 对于非相邻两站，只计算全程空闲的座位
    - 返回各席别的准确余票数量
    - 如果余票为0，返回"无"；大于等于20，返回"有"；小于20，返回具体数字
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持余票计算功能。"

- type: Backend
  id: API-GET-FilterOptions
  route: GET /api/trains/filter-options
  description: 获取车次筛选选项（出发站、到达站、席别）
  input:
    type: Query
    params:
      departureStation: string
      arrivalStation: string
      departureDate: string
  output:
    success:
      statusCode: 200
      body:
        departureStations: array
        arrivalStations: array
        seatTypes: array
    error:
      - statusCode: 400
        body: { error: "参数错误" }
      - statusCode: 500
        body: { error: "获取筛选选项失败" }
  dependencies:
    - DB-GetDepartureStations
    - DB-GetArrivalStations
    - DB-GetSeatTypes
  acceptanceCriteria:
    - 返回当前查询结果中所有唯一的出发站
    - 返回当前查询结果中所有唯一的到达站
    - 返回当前查询结果中所有唯一的席别类型
    - 用于车次信息筛选区域的选项自动补全
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持车次筛选选项获取。"

- type: Backend
  id: API-POST-ReserveTicket
  route: POST /api/tickets/reserve
  description: 预订车票
  input:
    type: JSON
    body:
      trainNo: string
      departureStation: string
      arrivalStation: string
      departureDate: string
      seatType: string
      passengerId: string
  output:
    success:
      statusCode: 200
      body:
        message: "预订成功"
        orderId: string
        redirectUrl: "/order-details"
    error:
      - statusCode: 401
        body: { error: "请先登录！" }
      - statusCode: 400
        body: { error: "手慢了，该车次车票已售罄！" }
      - statusCode: 400
        body: { error: "您选择的列车距开车时间很近了，进站约需20分钟，请确保有足够的时间办理安全检查、实名制验证及检票等手续，以免耽误您的旅行。" }
      - statusCode: 400
        body: { error: "页面内容已过期，请重新查询！" }
      - statusCode: 500
        body: { error: "网络忙，请稍后重试" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-CalculateAvailableSeats
    - DB-CreateReservation
    - DB-UpdateSeatStatus
  acceptanceCriteria:
    - 验证用户已登录
    - 检查车次是否有余票
    - 检查距离发车时间是否不足3小时，如果是则提示用户
    - 检查查询时间是否超过5分钟
    - 预订成功后更新座位状态并创建订单
    - 在100毫秒内跳转到购票页面
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持车票预订功能。"

- type: Backend
  id: API-GET-PersonalCenter
  route: GET /api/user/personal-center
  description: 获取用户个人中心页面
  input:
    type: Header
    params:
      Authorization: string  # JWT token
  output:
    success:
      statusCode: 200
      body:
        user: object
        orders: array
        passengers: array
    error:
      - statusCode: 401
        body: { error: "请先登录12306账号！" }
      - statusCode: 500
        body: { error: "前往个人中心失败，请稍后重试" }
  dependencies:
    - DB-CheckUserLoginStatus
  acceptanceCriteria:
    - 验证用户已登录
    - 返回用户基本信息和订单列表
    - 如果用户未登录，重定向到登录页
    - 在100毫秒内加载个人中心页面
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持个人中心访问。"

- type: Backend
  id: API-GET-AvailableDates
  route: GET /api/trains/available-dates
  description: 获取可选的出发日期列表
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body:
        availableDates: array  # 已放票的日期列表
        currentDate: string
    error:
      - statusCode: 500
        body: { error: "获取可选日期失败" }
  dependencies:
    - none
  acceptanceCriteria:
    - 返回已放票的日期列表
    - 不包含已过期或未开票的日期
    - 用于日期选择器的日期状态显示
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持出发日期选择。"

- type: Backend
  id: API-POST-ValidateStation
  route: POST /api/stations/validate
  description: 验证站点是否有效
  input:
    type: JSON
    body:
      stationName: string
  output:
    success:
      statusCode: 200
      body:
        valid: true
        station: object
    error:
      - statusCode: 400
        body: { valid: false, error: "无法匹配该出发地/到达地", suggestions: array }
  dependencies:
    - DB-GetAllStations
    - DB-SearchStations
  acceptanceCriteria:
    - 验证站点名称是否在系统支持的站点列表中
    - 如果站点无效，返回相似度匹配的推荐站点
    - 用于用户输入验证和智能推荐
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持站点验证和推荐。"
