# 后端API接口定义
# 基于登录页、注册页、首页查询页、车次列表页、订单填写页和个人信息页需求文档生成

- type: Backend
  id: API-POST-Login
  route: POST /api/auth/login
  description: 处理用户登录请求，支持用户名/邮箱/手机号登录
  input:
    type: JSON
    body:
      identifier: string  # 用户名/邮箱/手机号
      password: string
  output:
    success:
      statusCode: 200
      body: 
        message: "登录验证通过，需要短信验证"
        requireSmsVerification: true
        sessionId: "uuid"
    error:
      - statusCode: 400
        body: { error: "请输入用户名！" }
      - statusCode: 400
        body: { error: "请输入密码！" }
      - statusCode: 400
        body: { error: "密码长度不能少于6位！" }
      - statusCode: 401
        body: { error: "用户名或密码错误！" }
  dependencies:
    - DB-FindUserByUsername
    - DB-FindUserByEmail
    - DB-FindUserByPhone
    - DB-VerifyPassword
  acceptanceCriteria:
    - 验证输入字段的完整性和格式
    - 支持用户名、邮箱、手机号三种登录方式
    - 密码验证失败时清空密码字段（前端处理）
    - 验证成功后返回会话ID，准备进入短信验证流程
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持多种方式登录验证。"

- type: Backend
  id: API-POST-SendVerificationCode
  route: POST /api/auth/send-verification-code
  description: 发送短信验证码
  input:
    type: JSON
    body:
      sessionId: string
      idCardLast4: string  # 证件号后4位
  output:
    success:
      statusCode: 200
      body: { message: "获取短信验证码成功！" }
    error:
      - statusCode: 400
        body: { error: "请输入正确的用户信息！" }
      - statusCode: 429
        body: { error: "请求验证码过于频繁，请稍后再试！" }
      - statusCode: 401
        body: { error: "会话无效或已过期" }
  dependencies:
    - DB-FindUserByUsername
    - DB-FindUserByEmail
    - DB-FindUserByPhone
    - DB-CreateVerificationCode
    - DB-CheckVerificationCodeFrequency
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 验证证件号后4位是否与用户信息匹配
    - 检查发送频率限制（1分钟内只能发送一次）
    - 成功发送后启动60秒倒计时
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持短信验证码发送功能。"

- type: Backend
  id: API-POST-VerifyLogin
  route: POST /api/auth/verify-login
  description: 验证短信验证码并完成登录
  input:
    type: JSON
    body:
      sessionId: string
      idCardLast4: string
      verificationCode: string
  output:
    success:
      statusCode: 200
      body: 
        message: "登录成功"
        token: "jwt_token"
        userId: "uuid"
        redirectUrl: "/personal-center"
    error:
      - statusCode: 400
        body: { error: "请输入登录账号绑定的证件号后4位" }
      - statusCode: 400
        body: { error: "请输入验证码" }
      - statusCode: 400
        body: { error: "请输入正确的验证码" }
      - statusCode: 400
        body: { error: "验证码校验失败！" }
      - statusCode: 401
        body: { error: "很抱歉，您输入的短信验证码有误。" }
      - statusCode: 401
        body: { error: "会话无效或已过期" }
  dependencies:
    - DB-VerifyCode
    - DB-UpdateUserLoginStatus
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 验证证件号后4位不能为空
    - 验证码必须为6位数字
    - 验证码必须正确且未过期
    - 验证成功后生成JWT token并更新用户登录状态
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持短信验证码验证和登录完成。"

- type: Backend
  id: API-GET-HomePage
  route: GET /api/home
  description: 获取12306首页内容
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body: 
        pageContent: "object"
        banners: "array"
        announcements: "array"
  dependencies:
    - none
  acceptanceCriteria:
    - 返回首页所需的基本内容
    - 支持Logo点击跳转功能
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持Logo跳转到首页功能。"

- type: Backend
  id: API-GET-ForgotPassword
  route: GET /api/auth/forgot-password
  description: 获取忘记密码页面
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body: 
        pageContent: "object"
        resetOptions: "array"
  dependencies:
    - none
  acceptanceCriteria:
    - 返回忘记密码页面内容
    - 提供密码重置选项
  changeLog:
    - date: "2025-01-25"
      description: "初始创建，支持忘记密码页面跳转。"

- type: Backend
  id: API-POST-ValidateUsername
  route: POST /api/register/validate-username
  description: 验证用户名的合法性和可用性
  input:
    type: JSON
    body:
      username: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "用户名可用" }
    error:
      - statusCode: 400
        body: { valid: false, error: "用户名长度不能少于6个字符！" }
      - statusCode: 400
        body: { valid: false, error: "用户名长度不能超过30个字符！" }
      - statusCode: 400
        body: { valid: false, error: "用户名只能由字母、数字和_组成，须以字母开头！" }
      - statusCode: 409
        body: { valid: false, error: "该用户名已经占用，请重新选择用户名！" }
  dependencies:
    - DB-FindUserByUsername
  acceptanceCriteria:
    - 验证用户名长度在6-30个字符之间
    - 验证用户名以字母开头
    - 验证用户名只包含字母、数字和下划线
    - 验证用户名在数据库中的唯一性
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页用户名实时验证。"

- type: Backend
  id: API-POST-ValidatePassword
  route: POST /api/register/validate-password
  description: 验证密码的合法性
  input:
    type: JSON
    body:
      password: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "密码格式正确" }
    error:
      - statusCode: 400
        body: { valid: false, error: "密码长度不能少于6个字符！" }
      - statusCode: 400
        body: { valid: false, error: "格式错误，必须且只能包含字母、数字和下划线中的两种或两种以上！" }
  dependencies:
    - none
  acceptanceCriteria:
    - 验证密码长度大于等于6位
    - 验证密码只包含字母、数字和下划线
    - 验证密码必须包含字母、数字、下划线中的至少两种
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页密码格式验证。"

- type: Backend
  id: API-POST-ValidateName
  route: POST /api/register/validate-name
  description: 验证姓名的合法性
  input:
    type: JSON
    body:
      name: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "姓名格式正确" }
    error:
      - statusCode: 400
        body: { valid: false, error: "允许输入的字符串在3-30个字符之间！" }
      - statusCode: 400
        body: { valid: false, error: "请输入姓名！" }
  dependencies:
    - none
  acceptanceCriteria:
    - 验证姓名长度在3-30个字符之间（1个汉字算2个字符）
    - 验证姓名只包含中英文字符、"."和单空格
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页姓名格式验证。"

- type: Backend
  id: API-POST-ValidateIdCard
  route: POST /api/register/validate-idcard
  description: 验证证件号码的合法性和可用性
  input:
    type: JSON
    body:
      idCardType: string
      idCardNumber: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "证件号码格式正确且可用" }
    error:
      - statusCode: 400
        body: { valid: false, error: "请正确输入18位证件号码！" }
      - statusCode: 400
        body: { valid: false, error: "输入的证件编号中包含中文信息或特殊字符！" }
      - statusCode: 409
        body: { valid: false, error: "该证件号码已经被注册过，请确认是否您本人注册，"是"请使用原账号登录，"不是"请通过铁路12306App办理抢注或持该证件到就近的办理客运业务的铁路车站办理被抢注处理，完成后即可继续注册，或致电12306客服咨询。" }
  dependencies:
    - DB-FindUserByIdCardNumber
  acceptanceCriteria:
    - 验证证件号码长度为18个字符
    - 验证证件号码只包含数字和字母
    - 验证证件号码在数据库中的唯一性
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页证件号码验证。"

- type: Backend
  id: API-POST-ValidateEmail
  route: POST /api/register/validate-email
  description: 验证邮箱格式的合法性
  input:
    type: JSON
    body:
      email: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "邮箱格式正确" }
    error:
      - statusCode: 400
        body: { valid: false, error: "请输入有效的电子邮件地址！" }
  dependencies:
    - none
  acceptanceCriteria:
    - 验证邮箱包含"@"符号
    - 验证邮箱包含有效域名
    - 使用标准邮箱格式验证规则
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页邮箱格式验证。"

- type: Backend
  id: API-POST-ValidatePhone
  route: POST /api/register/validate-phone
  description: 验证手机号码的合法性
  input:
    type: JSON
    body:
      phone: string
  output:
    success:
      statusCode: 200
      body: { valid: true, message: "手机号码格式正确" }
    error:
      - statusCode: 400
        body: { valid: false, error: "您输入的手机号码不是有效的格式！" }
      - statusCode: 400
        body: { valid: false, error: "您输入的手机号码不是有效的格式！" }
  dependencies:
    - none
  acceptanceCriteria:
    - 验证手机号码长度为11位
    - 验证手机号码只包含数字
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册页手机号码格式验证。"

- type: Backend
  id: API-POST-Register
  route: POST /api/register
  description: 处理用户注册请求，创建新用户账户
  input:
    type: JSON
    body:
      username: string
      password: string
      confirmPassword: string
      idCardType: string
      name: string
      idCardNumber: string
      discountType: string
      email: string  # 可选
      phone: string
      agreedToTerms: boolean
  output:
    success:
      statusCode: 201
      body: { message: "注册信息已提交，请进行验证", sessionId: "uuid" }
    error:
      - statusCode: 400
        body: { error: "请填写完整信息！" }
      - statusCode: 400
        body: { error: "确认密码与密码不一致！" }
      - statusCode: 400
        body: { error: "请确认服务条款！" }
      - statusCode: 400
        body: { error: "请修正填写的信息！" }
      - statusCode: 409
        body: { error: "该用户名已经占用，请重新选择用户名！" }
      - statusCode: 409
        body: { error: "该证件号码已经被注册过" }
  dependencies:
    - DB-FindUserByUsername
    - DB-FindUserByIdCardNumber
    - DB-FindUserByPhone
    - DB-CreateVerificationCode
    - DB-CreateEmailVerificationCode
  acceptanceCriteria:
    - 验证所有必填字段完整性
    - 验证密码和确认密码一致性
    - 验证用户协议已勾选
    - 验证用户名、证件号码、手机号的唯一性
    - 创建用户会话并返回sessionId用于后续验证
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持用户注册功能。"

- type: Backend
  id: API-POST-SendRegistrationVerificationCode
  route: POST /api/register/send-verification-code
  description: 发送注册验证码（短信和邮箱）
  input:
    type: JSON
    body:
      sessionId: string
      phone: string
      email: string  # 可选
  output:
    success:
      statusCode: 200
      body: { message: "验证码发送成功" }
    error:
      - statusCode: 400
        body: { error: "会话无效或已过期" }
      - statusCode: 429
        body: { error: "请求验证码过于频繁，请稍后再试！" }
  dependencies:
    - DB-CreateVerificationCode
    - DB-CreateEmailVerificationCode
    - DB-CheckVerificationCodeFrequency
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 发送短信验证码到用户手机
    - 如果提供了邮箱，同时发送邮箱验证码
    - 检查发送频率限制
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册验证码发送功能。"

- type: Backend
  id: API-POST-CompleteRegistration
  route: POST /api/register/complete
  description: 验证验证码并完成用户注册
  input:
    type: JSON
    body:
      sessionId: string
      smsCode: string
      emailCode: string  # 可选
  output:
    success:
      statusCode: 201
      body: { message: "恭喜您注册成功，请到登录页面进行登录！" }
    error:
      - statusCode: 400
        body: { error: "验证码错误或已过期" }
      - statusCode: 400
        body: { error: "会话无效或已过期" }
      - statusCode: 500
        body: { error: "注册失败，请稍后重试" }
  dependencies:
    - DB-VerifyCode
    - DB-VerifyEmailCode
    - DB-CreateUser
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 验证短信验证码
    - 如果提供了邮箱验证码，同时验证邮箱验证码
    - 验证通过后创建用户记录
    - 清理临时会话数据
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持注册验证和用户创建功能。"

- type: Backend
  id: API-GET-ServiceTerms
  route: GET /api/terms/service-terms
  description: 获取《中国铁路客户服务中心网站服务条款》内容
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body: 
        title: "服务条款"
        content: "string"
  dependencies:
    - none
  acceptanceCriteria:
    - 返回服务条款的完整内容
    - 支持页面跳转和文本显示
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持服务条款页面访问。"

- type: Backend
  id: API-GET-PrivacyPolicy
  route: GET /api/terms/privacy-policy
  description: 获取《隐私权政策》内容
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body: 
        title: "隐私权政策"
        englishTitle: "NOTICE"
        content: "string"
  dependencies:
    - none
  acceptanceCriteria:
    - 返回隐私权政策的完整内容
    - 支持中英文标题显示
    - 支持页面跳转和文本显示
  changeLog:
    - date: "2025-11-10"
      description: "初始创建，支持隐私权政策页面访问。"

# === 首页查询页和车次列表页相关API接口 ===

- type: Backend
  id: API-GET-Stations
  route: GET /api/stations
  description: 获取所有可用站点列表
  input:
    type: Query
    params:
      keyword: string  # 可选，用于站点搜索
  output:
    success:
      statusCode: 200
      body:
        stations: "array"  # [{ name: string, code: string, pinyin: string }]
    error:
      - statusCode: 500
        body: { error: "获取站点列表失败" }
  dependencies:
    - DB-GetAllStations
    - DB-SearchStations
  acceptanceCriteria:
    - 如果未提供keyword，返回所有站点列表
    - 如果提供keyword，返回模糊匹配的站点列表
    - 支持按简拼、全拼、汉字搜索
    - 用于出发地和到达地的下拉推荐
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持站点查询和推荐功能。"

- type: Backend
  id: API-POST-SearchTrains
  route: POST /api/trains/search
  description: 搜索符合条件的车次列表
  input:
    type: JSON
    body:
      departureStation: string
      arrivalStation: string
      departureDate: string  # YYYY-MM-DD格式
      trainTypes: array  # 可选，如 ["G", "C", "D"]
  output:
    success:
      statusCode: 200
      body:
        trains: "array"  # 车次列表
        timestamp: "string"  # 查询时间戳，用于检测5分钟过期
    error:
      - statusCode: 400
        body: { error: "请选择出发地" }
      - statusCode: 400
        body: { error: "请选择到达地" }
      - statusCode: 400
        body: { error: "无法匹配该出发地" }
      - statusCode: 400
        body: { error: "无法匹配该到达地" }
      - statusCode: 500
        body: { error: "查询失败，请稍后重试" }
  dependencies:
    - DB-SearchTrains
    - DB-GetAllStations
  acceptanceCriteria:
    - 验证出发地和到达地不为空
    - 验证出发地和到达地在系统支持的站点列表中
    - 出发日期默认为当前日期
    - 支持按车次类型筛选（高铁/动车）
    - 在100毫秒内返回查询结果
    - 仅返回直达车次，不包含换乘
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持车次查询功能。"

- type: Backend
  id: API-GET-TrainDetails
  route: GET /api/trains/:trainNo
  description: 获取指定车次的详细信息
  input:
    type: Path
    params:
      trainNo: string
  output:
    success:
      statusCode: 200
      body:
        trainNo: string
        trainType: string
        model: string
        route: object
        stops: array
        cars: array
        fares: object
        availableSeats: object
    error:
      - statusCode: 404
        body: { error: "车次不存在" }
      - statusCode: 500
        body: { error: "获取车次详情失败" }
  dependencies:
    - DB-GetTrainDetails
    - DB-GetTrainStops
    - DB-CalculateAvailableSeats
  acceptanceCriteria:
    - 返回车次的完整信息
    - 包含所有停靠站点和时刻表
    - 包含车厢配置和席别信息
    - 包含票价和余票信息
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持车次详情查询。"

- type: Backend
  id: API-POST-CalculateAvailableSeats
  route: POST /api/trains/available-seats
  description: 计算指定车次在指定区间的余票数
  input:
    type: JSON
    body:
      trainNo: string
      departureStation: string
      arrivalStation: string
      departureDate: string
  output:
    success:
      statusCode: 200
      body:
        trainNo: string
        availableSeats: object  # { "商务座": 10, "一等座": 50, "二等座": 100 }
    error:
      - statusCode: 400
        body: { error: "参数错误" }
      - statusCode: 404
        body: { error: "车次不存在" }
      - statusCode: 500
        body: { error: "计算余票失败" }
  dependencies:
    - DB-CalculateAvailableSeats
    - DB-GetSeatStatus
  acceptanceCriteria:
    - 准确计算各席别的余票数
    - 对于非相邻两站，只计算全程空闲的座位
    - 返回各席别的准确余票数量
    - 如果余票为0，返回"无"；大于等于20，返回"有"；小于20，返回具体数字
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持余票计算功能。"

- type: Backend
  id: API-GET-FilterOptions
  route: GET /api/trains/filter-options
  description: 获取车次筛选选项（出发站、到达站、席别）
  input:
    type: Query
    params:
      departureStation: string
      arrivalStation: string
      departureDate: string
  output:
    success:
      statusCode: 200
      body:
        departureStations: array
        arrivalStations: array
        seatTypes: array
    error:
      - statusCode: 400
        body: { error: "参数错误" }
      - statusCode: 500
        body: { error: "获取筛选选项失败" }
  dependencies:
    - DB-GetDepartureStations
    - DB-GetArrivalStations
    - DB-GetSeatTypes
  acceptanceCriteria:
    - 返回当前查询结果中所有唯一的出发站
    - 返回当前查询结果中所有唯一的到达站
    - 返回当前查询结果中所有唯一的席别类型
    - 用于车次信息筛选区域的选项自动补全
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持车次筛选选项获取。"

- type: Backend
  id: API-POST-ReserveTicket
  route: POST /api/tickets/reserve
  description: 预订车票
  input:
    type: JSON
    body:
      trainNo: string
      departureStation: string
      arrivalStation: string
      departureDate: string
      seatType: string
      passengerId: string
  output:
    success:
      statusCode: 200
      body:
        message: "预订成功"
        orderId: string
        redirectUrl: "/order-details"
    error:
      - statusCode: 401
        body: { error: "请先登录！" }
      - statusCode: 400
        body: { error: "手慢了，该车次车票已售罄！" }
      - statusCode: 400
        body: { error: "您选择的列车距开车时间很近了，进站约需20分钟，请确保有足够的时间办理安全检查、实名制验证及检票等手续，以免耽误您的旅行。" }
      - statusCode: 400
        body: { error: "页面内容已过期，请重新查询！" }
      - statusCode: 500
        body: { error: "网络忙，请稍后重试" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-CalculateAvailableSeats
    - DB-CreateReservation
    - DB-UpdateSeatStatus
  acceptanceCriteria:
    - 验证用户已登录
    - 检查车次是否有余票
    - 检查距离发车时间是否不足3小时，如果是则提示用户
    - 检查查询时间是否超过5分钟
    - 预订成功后更新座位状态并创建订单
    - 在100毫秒内跳转到购票页面
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持车票预订功能。"

- type: Backend
  id: API-GET-PersonalCenter
  route: GET /api/user/personal-center
  description: 获取用户个人中心页面
  input:
    type: Header
    params:
      Authorization: string  # JWT token
  output:
    success:
      statusCode: 200
      body:
        user: object
        orders: array
        passengers: array
    error:
      - statusCode: 401
        body: { error: "请先登录12306账号！" }
      - statusCode: 500
        body: { error: "前往个人中心失败，请稍后重试" }
  dependencies:
    - DB-CheckUserLoginStatus
  acceptanceCriteria:
    - 验证用户已登录
    - 返回用户基本信息和订单列表
    - 如果用户未登录，重定向到登录页
    - 在100毫秒内加载个人中心页面
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持个人中心访问。"

- type: Backend
  id: API-GET-AvailableDates
  route: GET /api/trains/available-dates
  description: 获取可选的出发日期列表
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body:
        availableDates: array  # 已放票的日期列表
        currentDate: string
    error:
      - statusCode: 500
        body: { error: "获取可选日期失败" }
  dependencies:
    - none
  acceptanceCriteria:
    - 返回已放票的日期列表
    - 不包含已过期或未开票的日期
    - 用于日期选择器的日期状态显示
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持出发日期选择。"

- type: Backend
  id: API-POST-ValidateStation
  route: POST /api/stations/validate
  description: 验证站点是否有效
  input:
    type: JSON
    body:
      stationName: string
  output:
    success:
      statusCode: 200
      body:
        valid: true
        station: object
    error:
      - statusCode: 400
        body: { valid: false, error: "无法匹配该出发地/到达地", suggestions: array }
  dependencies:
    - DB-GetAllStations
    - DB-SearchStations
  acceptanceCriteria:
    - 验证站点名称是否在系统支持的站点列表中
    - 如果站点无效，返回相似度匹配的推荐站点
    - 用于用户输入验证和智能推荐
  changeLog:
    - date: "2025-11-12"
      description: "初始创建，支持站点验证和推荐。"

# === 订单填写页相关API接口 ===

- type: Backend
  id: API-GET-OrderPage
  route: GET /api/orders/new
  description: 获取订单填写页面信息
  input:
    type: Query
    params:
      trainNo: string
      departureStation: string
      arrivalStation: string
      departureDate: string
  output:
    success:
      statusCode: 200
      body:
        trainInfo: object  # 列车基本信息
        fareInfo: object  # 票价信息
        availableSeats: object  # 余票信息
        passengers: array  # 用户乘客列表
        defaultSeatType: string  # 默认席别
    error:
      - statusCode: 400
        body: { error: "参数错误" }
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 404
        body: { error: "车次不存在" }
      - statusCode: 500
        body: { error: "加载订单页失败" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-GetTrainDetails
    - DB-CalculateFare
    - DB-CalculateAvailableSeats
    - DB-GetUserPassengers
    - DB-GetDefaultSeatType
  acceptanceCriteria:
    - 验证用户已登录
    - 返回列车的日期、车次、出发站、到达站、发车与到达时间
    - 返回不同席别的票价和余票状态
    - 返回用户的乘客列表
    - 根据车次类型返回默认席别（G/C/D字头默认二等座）
    - 在100毫秒内返回页面数据
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持订单填写页面数据加载。"

- type: Backend
  id: API-GET-Passengers
  route: GET /api/passengers
  description: 获取用户的乘客列表
  input:
    type: Header
    params:
      Authorization: string
  output:
    success:
      statusCode: 200
      body:
        passengers: array  # [{ id, name, idCardType, idCardNumber, discountType, points }]
    error:
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 500
        body: { error: "获取乘客列表失败" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-GetUserPassengers
  acceptanceCriteria:
    - 验证用户已登录
    - 返回用户在个人中心预存的所有乘客信息
    - 包含姓名、证件类型、证件号码、积分等信息
    - 证件号码部分脱敏显示（如：3301************028）
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持乘客列表查询。"

- type: Backend
  id: API-POST-SearchPassengers
  route: POST /api/passengers/search
  description: 搜索乘客
  input:
    type: JSON
    body:
      keyword: string  # 乘客姓名关键词
  output:
    success:
      statusCode: 200
      body:
        passengers: array
    error:
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 500
        body: { error: "搜索失败" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-SearchPassengers
  acceptanceCriteria:
    - 验证用户已登录
    - 根据姓名关键词搜索匹配的乘客
    - 支持模糊匹配
    - 用于订单填写页的乘客搜索功能
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持乘客搜索。"

- type: Backend
  id: API-GET-AvailableSeatTypes
  route: GET /api/orders/available-seat-types
  description: 获取当前有票的席别列表
  input:
    type: Query
    params:
      trainNo: string
      departureStation: string
      arrivalStation: string
      departureDate: string
  output:
    success:
      statusCode: 200
      body:
        seatTypes: array  # [{ type: string, price: number, available: number }]
    error:
      - statusCode: 400
        body: { error: "参数错误" }
      - statusCode: 404
        body: { error: "车次不存在" }
      - statusCode: 500
        body: { error: "获取席别信息失败" }
  dependencies:
    - DB-GetAvailableSeatTypesForOrder
    - DB-CalculateAvailableSeats
    - DB-CalculateFare
  acceptanceCriteria:
    - 仅返回当前有余票的席别
    - 包含席别名称、票价和余票数
    - 已售罄的席别不包含在列表中
    - 用于订单填写页席别下拉菜单
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持有票席别查询。"

- type: Backend
  id: API-POST-SubmitOrder
  route: POST /api/orders/submit
  description: 提交订单
  input:
    type: JSON
    body:
      trainNo: string
      departureStation: string
      arrivalStation: string
      departureDate: string
      passengers: array  # [{ passengerId, ticketType, seatType }]
  output:
    success:
      statusCode: 200
      body:
        message: "订单提交成功"
        orderId: string
        orderDetails: object  # 订单详情用于信息核对
    error:
      - statusCode: 400
        body: { error: "请选择乘车人！" }
      - statusCode: 400
        body: { error: "手慢了，该车次席别车票已售罄！" }
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 500
        body: { error: "网络忙，请稍后再试" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-GetUserPassengers
    - DB-CalculateAvailableSeats
    - DB-CreateOrder
    - DB-LockSeats
  acceptanceCriteria:
    - 验证用户已登录
    - 验证至少选择了一名乘车人
    - 验证所选席别有足够余票
    - 创建订单并临时锁定座位
    - 在100毫秒内返回订单详情并跳出信息核对弹窗
    - 订单一旦提交成功，不支持取消、退票、改签
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持订单提交。"

- type: Backend
  id: API-GET-OrderConfirmation
  route: GET /api/orders/:orderId/confirmation
  description: 获取订单核对信息
  input:
    type: Path
    params:
      orderId: string
  output:
    success:
      statusCode: 200
      body:
        trainInfo: object  # 车次与出行信息
        passengers: array  # 乘客信息（含积分）
        availableSeats: object  # 当前余票信息
        totalPrice: number
    error:
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 404
        body: { error: "订单不存在" }
      - statusCode: 500
        body: { error: "获取订单信息失败" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-GetOrderDetails
    - DB-GetPassengerPoints
    - DB-CalculateAvailableSeats
  acceptanceCriteria:
    - 验证用户已登录且订单属于该用户
    - 返回完整的订单核对信息
    - 包含车次信息、乘客信息（含积分）、余票状态
    - 用于信息核对弹窗展示
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持订单核对信息获取。"

- type: Backend
  id: API-POST-ConfirmOrder
  route: POST /api/orders/:orderId/confirm
  description: 确认订单
  input:
    type: Path
    params:
      orderId: string
  output:
    success:
      statusCode: 200
      body:
        message: "订单已经提交，系统正在处理中，请稍等"
        orderId: string
        status: "processing"
    error:
      - statusCode: 400
        body: { error: "订单状态错误" }
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 404
        body: { error: "订单不存在" }
      - statusCode: 500
        body: { error: "确认订单失败" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-GetOrderDetails
    - DB-UpdateOrderStatus
    - DB-ConfirmSeatAllocation
  acceptanceCriteria:
    - 验证用户已登录且订单属于该用户
    - 确认座位分配
    - 更新订单状态为处理中
    - 后续显示"购买成功"提示
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持订单确认。"

- type: Backend
  id: API-POST-AddPassenger
  route: POST /api/passengers
  description: 添加乘客信息
  input:
    type: JSON
    body:
      name: string
      idCardType: string
      idCardNumber: string
      discountType: string  # 固定为"成人票"，不支持学生票、儿童票
  output:
    success:
      statusCode: 201
      body:
        message: "添加乘客成功"
        passengerId: string
    error:
      - statusCode: 400
        body: { error: "参数错误" }
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 409
        body: { error: "该乘客已存在" }
      - statusCode: 500
        body: { error: "添加乘客失败" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-CreatePassenger
  acceptanceCriteria:
    - 验证用户已登录
    - 验证乘客信息的完整性和格式
    - 验证证件号码的唯一性
    - 创建新的乘客记录并关联到用户
    - 用于个人中心添加乘客功能
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持添加乘客。"

- type: Backend
  id: API-GET-RailwayRegulations
  route: GET /api/terms/railway-regulations
  description: 获取《中国集团铁路旅客运输规程》内容
  input:
    type: Query
    params: {}
  output:
    success:
      statusCode: 200
      body:
        title: "中国集团铁路旅客运输规程"
        content: string
    error:
      - statusCode: 500
        body: { error: "获取内容失败" }
  dependencies:
    - none
  acceptanceCriteria:
    - 返回铁路旅客运输规程的完整内容
    - 用于订单提交页面的提示链接
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持运输规程页面访问。"

# === 个人信息页相关API接口 ===

- type: Backend
  id: API-GET-UserInfo
  route: GET /api/user/info
  description: 获取用户个人信息
  input:
    type: Header
    params:
      Authorization: string  # JWT token
  output:
    success:
      statusCode: 200
      body:
        username: string
        name: string
        country: string
        idCardType: string
        idCardNumber: string
        verificationStatus: string
        phone: string  # 脱敏显示
        email: string
        discountType: string
    error:
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 500
        body: { error: "获取用户信息失败" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-GetUserInfo
  acceptanceCriteria:
    - 验证用户已登录
    - 返回用户的完整个人信息
    - 手机号中间四位用*隐去
    - 用于用户基本信息页展示
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持用户基本信息查询。"

- type: Backend
  id: API-PUT-UserEmail
  route: PUT /api/user/email
  description: 更新用户邮箱
  input:
    type: JSON
    body:
      email: string
  output:
    success:
      statusCode: 200
      body: { message: "邮箱更新成功" }
    error:
      - statusCode: 400
        body: { error: "请输入有效的电子邮件地址！" }
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 500
        body: { error: "更新邮箱失败" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-UpdateUserEmail
  acceptanceCriteria:
    - 验证用户已登录
    - 验证邮箱格式的合法性
    - 更新用户邮箱地址
    - 用于联系方式模块编辑功能
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持用户邮箱更新。"

- type: Backend
  id: API-POST-UpdatePhoneRequest
  route: POST /api/user/phone/update-request
  description: 请求更新用户手机号（发送验证码）
  input:
    type: JSON
    body:
      newPhone: string
      password: string
  output:
    success:
      statusCode: 200
      body: 
        message: "验证码已发送"
        sessionId: string
    error:
      - statusCode: 400
        body: { error: "您输入的手机号码不是有效的格式！" }
      - statusCode: 400
        body: { error: "输入登录密码！" }
      - statusCode: 401
        body: { error: "密码错误" }
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 409
        body: { error: "该手机号已被使用" }
      - statusCode: 500
        body: { error: "发送验证码失败" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-VerifyPassword
    - DB-FindUserByPhone
    - DB-CreateVerificationCode
  acceptanceCriteria:
    - 验证用户已登录
    - 验证新手机号格式正确且长度为11位
    - 验证新手机号未被其他用户使用
    - 验证用户登录密码正确
    - 发送验证码到新手机号
    - 返回会话ID用于后续验证
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持手机号更新请求。"

- type: Backend
  id: API-POST-ConfirmPhoneUpdate
  route: POST /api/user/phone/confirm-update
  description: 确认更新用户手机号（验证验证码）
  input:
    type: JSON
    body:
      sessionId: string
      verificationCode: string
  output:
    success:
      statusCode: 200
      body: { message: "手机号更新成功" }
    error:
      - statusCode: 400
        body: { error: "请输入验证码" }
      - statusCode: 400
        body: { error: "验证码错误或已过期" }
      - statusCode: 401
        body: { error: "会话无效或已过期" }
      - statusCode: 500
        body: { error: "更新手机号失败" }
  dependencies:
    - DB-VerifyCode
    - DB-UpdateUserPhone
  acceptanceCriteria:
    - 验证会话ID的有效性
    - 验证短信验证码正确且未过期
    - 更新用户手机号
    - 控制台显示验证码信息
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持手机号更新确认。"

- type: Backend
  id: API-PUT-Passenger
  route: PUT /api/passengers/:passengerId
  description: 更新乘客信息
  input:
    type: Path
    params:
      passengerId: string
    body:
      phone: string
  output:
    success:
      statusCode: 200
      body: { message: "修改成功" }
    error:
      - statusCode: 400
        body: { error: "您输入的手机号码不是有效的格式！" }
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 404
        body: { error: "乘客不存在" }
      - statusCode: 500
        body: { error: "更新乘客信息失败" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-GetPassengerDetails
    - DB-UpdatePassenger
  acceptanceCriteria:
    - 验证用户已登录
    - 验证乘客属于当前用户
    - 验证手机号格式正确
    - 更新乘客的手机号
    - 用于编辑乘客页面
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持乘客信息更新。"

- type: Backend
  id: API-DELETE-Passenger
  route: DELETE /api/passengers/:passengerId
  description: 删除乘客信息
  input:
    type: Path
    params:
      passengerId: string
  output:
    success:
      statusCode: 200
      body: { message: "删除成功" }
    error:
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 404
        body: { error: "乘客不存在" }
      - statusCode: 400
        body: { error: "该乘客有未完成的订单，无法删除" }
      - statusCode: 500
        body: { error: "删除乘客失败" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-GetPassengerDetails
    - DB-DeletePassenger
  acceptanceCriteria:
    - 验证用户已登录
    - 验证乘客属于当前用户
    - 检查乘客是否有未完成的订单
    - 删除乘客记录
    - 用于乘客管理页
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持乘客删除。"

- type: Backend
  id: API-GET-UserOrders
  route: GET /api/user/orders
  description: 获取用户订单列表
  input:
    type: Query
    params:
      startDate: string  # 可选，开始日期
      endDate: string  # 可选，结束日期
      keyword: string  # 可选，订单号/车次/姓名
  output:
    success:
      statusCode: 200
      body:
        orders: array
    error:
      - statusCode: 401
        body: { error: "请先登录" }
      - statusCode: 500
        body: { error: "获取订单列表失败" }
  dependencies:
    - DB-CheckUserLoginStatus
    - DB-GetUserOrders
    - DB-SearchOrders
  acceptanceCriteria:
    - 验证用户已登录
    - 支持按日期范围筛选订单
    - 支持按订单号、车次号、乘客姓名搜索
    - 返回用户的订单列表
    - 订单信息保存期限为30日
    - 用于历史订单页
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持订单列表查询。"

- type: Backend
  id: API-POST-ValidatePassenger
  route: POST /api/passengers/validate
  description: 验证乘客信息的合法性
  input:
    type: JSON
    body:
      name: string
      idCardType: string
      idCardNumber: string
      phone: string
      discountType: string
  output:
    success:
      statusCode: 200
      body: { valid: true }
    error:
      - statusCode: 400
        body: { valid: false, error: "允许输入的字符串在3-30个字符之间！" }
      - statusCode: 400
        body: { valid: false, error: "请输入姓名！" }
      - statusCode: 400
        body: { valid: false, error: "请正确输入18位证件号码！" }
      - statusCode: 400
        body: { valid: false, error: "输入的证件编号中包含中文信息或特殊字符！" }
      - statusCode: 400
        body: { valid: false, error: "您输入的手机号码不是有效的格式！" }
      - statusCode: 409
        body: { valid: false, error: "该联系人已存在，请使用不同的姓名和证件。" }
  dependencies:
    - DB-CheckPassengerExists
  acceptanceCriteria:
    - 验证姓名长度在3-30个字符之间
    - 验证姓名只包含中英文字符、"."和单空格
    - 验证证件号码长度为18个字符
    - 验证证件号码只包含数字和字母
    - 验证手机号长度为11位且只包含数字
    - 验证乘客信息在用户的乘客列表中的唯一性
  changeLog:
    - date: "2025-11-13"
      description: "初始创建，支持乘客信息验证。"
