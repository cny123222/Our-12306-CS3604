# 数据库架构与接口分析报告

## 一、数据库架构概览

本项目使用 **SQLite** 数据库，数据库文件位于 `backend/database/railway.db`。

数据库包含以下模块：
- **用户模块**：用户信息、认证、会话管理
- **乘客模块**：乘客信息管理
- **车次模块**：车次信息、站点、票价、座位
- **订单模块**：订单管理、订单明细

---

## 二、数据库表结构

### 2.1 用户相关表

#### 1. users（用户表）
存储用户基本信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键，自增 | PRIMARY KEY |
| username | TEXT | 用户名 | UNIQUE, NOT NULL |
| password | TEXT | 密码（加密） | NOT NULL |
| name | TEXT | 真实姓名 | - |
| email | TEXT | 邮箱地址 | - |
| phone | TEXT | 手机号 | UNIQUE, NOT NULL |
| id_card_type | TEXT | 证件类型 | - |
| id_card_number | TEXT | 证件号码 | UNIQUE(id_card_type, id_card_number) |
| discount_type | TEXT | 优惠类型（成人、学生等） | - |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | DATETIME | 更新时间 | DEFAULT CURRENT_TIMESTAMP |
| last_login | DATETIME | 最后登录时间 | - |

#### 2. passengers（乘客表）
存储用户的常用乘客信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | TEXT | 主键（UUID） | PRIMARY KEY |
| user_id | TEXT | 用户ID | NOT NULL, FOREIGN KEY |
| name | TEXT | 乘客姓名 | NOT NULL |
| id_card_type | TEXT | 证件类型 | NOT NULL |
| id_card_number | TEXT | 证件号码 | NOT NULL |
| discount_type | TEXT | 优惠类型 | NOT NULL |
| points | INTEGER | 积分 | DEFAULT 0 |
| created_at | TEXT | 创建时间 | NOT NULL |
| updated_at | TEXT | 更新时间 | - |

**索引：**
- `idx_passengers_user_id` - 用户ID索引
- `idx_passengers_id_card` - 证件号码索引

#### 3. orders（订单表）
存储订单基本信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | TEXT | 主键（UUID） | PRIMARY KEY |
| user_id | TEXT | 用户ID | NOT NULL, FOREIGN KEY |
| train_number | TEXT | 车次号 | NOT NULL |
| departure_station | TEXT | 出发站 | NOT NULL |
| arrival_station | TEXT | 到达站 | NOT NULL |
| departure_date | TEXT | 出发日期 | NOT NULL |
| departure_time | TEXT | 出发时间 | - |
| arrival_time | TEXT | 到达时间 | - |
| total_price | REAL | 总价格 | NOT NULL |
| status | TEXT | 订单状态（pending/completed/cancelled） | NOT NULL |
| created_at | TEXT | 创建时间 | NOT NULL |
| updated_at | TEXT | 更新时间 | - |

**索引：**
- `idx_orders_user_id` - 用户ID索引
- `idx_orders_status` - 订单状态索引

#### 4. order_details（订单明细表）
存储订单的详细乘客信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键，自增 | PRIMARY KEY |
| order_id | TEXT | 订单ID | NOT NULL, FOREIGN KEY |
| passenger_id | TEXT | 乘客ID | NOT NULL, FOREIGN KEY |
| passenger_name | TEXT | 乘客姓名 | NOT NULL |
| id_card_type | TEXT | 证件类型 | NOT NULL |
| id_card_number | TEXT | 证件号码 | NOT NULL |
| seat_type | TEXT | 席别类型 | NOT NULL |
| ticket_type | TEXT | 票种类型 | NOT NULL |
| price | REAL | 票价 | NOT NULL |
| sequence_number | INTEGER | 序号 | - |
| car_number | TEXT | 车厢号 | - |
| seat_number | TEXT | 座位号 | - |

**索引：**
- `idx_order_details_order_id` - 订单ID索引

#### 5. verification_codes（短信验证码表）
存储短信验证码信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键，自增 | PRIMARY KEY |
| phone | TEXT | 手机号 | NOT NULL |
| code | TEXT | 验证码 | NOT NULL |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| expires_at | DATETIME | 过期时间 | NOT NULL |
| used | BOOLEAN | 是否已使用 | DEFAULT 0 |
| sent_status | TEXT | 发送状态 | DEFAULT 'sent' |
| sent_at | DATETIME | 发送时间 | DEFAULT CURRENT_TIMESTAMP |

#### 6. email_verification_codes（邮箱验证码表）
存储邮箱验证码信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键，自增 | PRIMARY KEY |
| email | TEXT | 邮箱地址 | NOT NULL |
| code | TEXT | 验证码 | NOT NULL |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| expires_at | DATETIME | 过期时间 | NOT NULL |
| used | BOOLEAN | 是否已使用 | DEFAULT 0 |
| sent_status | TEXT | 发送状态 | DEFAULT 'sent' |
| sent_at | DATETIME | 发送时间 | DEFAULT CURRENT_TIMESTAMP |

#### 7. sessions（会话表）
存储用户会话信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键，自增 | PRIMARY KEY |
| session_id | TEXT | 会话ID | UNIQUE, NOT NULL |
| user_data | TEXT | 用户数据（JSON） | - |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| expires_at | DATETIME | 过期时间 | NOT NULL |

#### 8. seat_locks（座位锁定表）
存储座位锁定信息（预留，可能未完全实现）

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键，自增 | PRIMARY KEY |
| order_id | TEXT | 订单ID | NOT NULL, FOREIGN KEY |
| train_number | TEXT | 车次号 | NOT NULL |
| seat_type | TEXT | 席别类型 | NOT NULL |
| car_number | TEXT | 车厢号 | - |
| seat_number | TEXT | 座位号 | - |
| locked_at | TEXT | 锁定时间 | NOT NULL |
| expires_at | TEXT | 过期时间 | NOT NULL |

---

### 2.2 车次相关表

#### 1. stations（站点表）
存储所有铁路站点信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键，自增 | PRIMARY KEY |
| name | TEXT | 站点名称 | UNIQUE, NOT NULL |
| code | TEXT | 站点代码 | - |
| pinyin | TEXT | 站点拼音（全拼） | - |
| short_pinyin | TEXT | 站点简拼 | - |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |

#### 2. trains（车次表）
存储车次基本信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键，自增 | PRIMARY KEY |
| train_no | TEXT | 车次号 | UNIQUE, NOT NULL |
| train_type | TEXT | 车次类型（高速动车组、动车组等） | NOT NULL |
| model | TEXT | 车型 | - |
| is_direct | BOOLEAN | 是否直达 | DEFAULT 1 |
| has_air_conditioning | BOOLEAN | 是否有空调 | DEFAULT 1 |
| origin_station | TEXT | 始发站 | NOT NULL |
| destination_station | TEXT | 终点站 | NOT NULL |
| distance_km | INTEGER | 总里程（公里） | - |
| planned_duration_min | INTEGER | 计划历时（分钟） | - |
| departure_time | TEXT | 出发时间 | - |
| arrival_time | TEXT | 到达时间 | - |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |

#### 3. train_stops（车次停靠站表）
存储车次的所有停靠站信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键，自增 | PRIMARY KEY |
| train_no | TEXT | 车次号 | NOT NULL, FOREIGN KEY |
| seq | INTEGER | 停靠序号 | NOT NULL |
| station | TEXT | 站点名称 | NOT NULL |
| arrive_time | TEXT | 到达时间 | - |
| depart_time | TEXT | 出发时间 | - |
| stop_min | INTEGER | 停靠时长（分钟） | DEFAULT 0 |

#### 4. train_cars（车厢配置表）
存储车次的车厢配置

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键，自增 | PRIMARY KEY |
| train_no | TEXT | 车次号 | NOT NULL, FOREIGN KEY |
| car_no | INTEGER | 车厢号 | NOT NULL |
| seat_type | TEXT | 席别类型（商务座、一等座、二等座、软卧、硬卧、餐车） | NOT NULL |

#### 5. train_fares（票价表）
存储车次各区间的票价信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键，自增 | PRIMARY KEY |
| train_no | TEXT | 车次号 | NOT NULL, FOREIGN KEY |
| from_station | TEXT | 起始站 | NOT NULL |
| to_station | TEXT | 终点站 | NOT NULL |
| distance_km | INTEGER | 区间里程（公里） | - |
| second_class_price | REAL | 二等座票价 | - |
| first_class_price | REAL | 一等座票价 | - |
| business_price | REAL | 商务座票价 | - |
| hard_sleeper_price | REAL | 硬卧票价 | - |
| soft_sleeper_price | REAL | 软卧票价 | - |

**票价计算规则：**
- 对于相邻两站，直接使用该区间的票价
- 对于非相邻两站，累加途经所有区间的票价

#### 6. seat_status（座位状态表）
存储每个座位在各区间的状态

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键，自增 | PRIMARY KEY |
| train_no | TEXT | 车次号 | NOT NULL, FOREIGN KEY |
| car_no | INTEGER | 车厢号 | NOT NULL |
| seat_no | TEXT | 座位号（格式：车厢号-序号，如 "1-01"） | NOT NULL |
| seat_type | TEXT | 席别类型 | NOT NULL |
| from_station | TEXT | 起始站 | NOT NULL |
| to_station | TEXT | 终点站 | NOT NULL |
| status | TEXT | 状态（available/booked） | DEFAULT 'available' |
| booked_by | TEXT | 预订用户ID | - |
| booked_at | DATETIME | 预订时间 | - |

**座位状态管理：**
- 每个座位在每个区间段都有独立的记录
- 状态：`available`（可用）、`booked`（已预订）
- 初始化时，为每个车次的每个座位在每个区间段创建记录

**余票计算逻辑：**
- **相邻两站**：直接统计该区间内状态为 `available` 的座位数
- **非相邻两站**：只有座位在出发站到到达站的所有区间都是 `available` 状态时，才计入余票

---

## 三、API接口清单

### 3.1 用户认证接口

#### POST /api/auth/login
用户登录

**请求体：**
```json
{
  "identifier": "用户名/邮箱/手机号",
  "password": "密码"
}
```

**响应：**
```json
{
  "token": "JWT令牌",
  "user": {
    "id": 1,
    "username": "用户名"
  }
}
```

#### POST /api/auth/send-verification-code
发送短信验证码

**请求体：**
```json
{
  "sessionId": "会话ID",
  "idCardLast4": "证件号后4位"
}
```

#### POST /api/auth/verify-login
短信验证登录

**请求体：**
```json
{
  "sessionId": "会话ID",
  "verificationCode": "验证码"
}
```

#### GET /api/auth/homepage
获取首页内容

#### GET /api/auth/forgot-password
获取忘记密码页面

---

### 3.2 用户注册接口

#### POST /api/auth/validate-username
验证用户名

#### POST /api/auth/validate-password
验证密码

#### POST /api/auth/validate-name
验证姓名

#### POST /api/auth/validate-idcard
验证证件号码

#### POST /api/auth/validate-email
验证邮箱

#### POST /api/auth/validate-phone
验证手机号

#### POST /api/register
用户注册

#### POST /api/register/send-verification-code
发送注册验证码

#### POST /api/register/complete
完成注册

#### GET /api/terms/service-terms
获取服务条款

#### GET /api/terms/privacy-policy
获取隐私政策

---

### 3.3 用户信息接口

#### GET /api/user/info
获取用户个人信息

**认证：** 需要登录

**响应：**
```json
{
  "username": "用户名",
  "name": "姓名",
  "country": "中国China",
  "idCardType": "居民身份证",
  "idCardNumber": "证件号码",
  "verificationStatus": "已通过",
  "phone": "(+86)158****9968",
  "email": "邮箱地址",
  "discountType": "成人"
}
```

#### PUT /api/user/email
更新用户邮箱

**请求体：**
```json
{
  "email": "新邮箱地址"
}
```

#### POST /api/user/phone/update-request
请求更新用户手机号（发送验证码）

**请求体：**
```json
{
  "newPhone": "新手机号",
  "password": "登录密码"
}
```

#### POST /api/user/phone/confirm-update
确认更新用户手机号（验证验证码）

**请求体：**
```json
{
  "sessionId": "会话ID",
  "verificationCode": "验证码"
}
```

#### GET /api/user/orders
获取用户订单列表

**查询参数：**
- `startDate` - 开始日期（可选）
- `endDate` - 结束日期（可选）
- `keyword` - 搜索关键词（可选）

**响应：**
```json
{
  "orders": [
    {
      "orderId": "订单ID",
      "orderNumber": "订单号",
      "trainNo": "车次号",
      "departureStation": "出发站",
      "arrivalStation": "到达站",
      "departureDate": "出发日期",
      "status": "订单状态",
      "totalPrice": 100.0,
      "createdAt": "创建时间"
    }
  ]
}
```

---

### 3.4 站点接口

#### GET /api/stations
获取所有可用站点列表

**查询参数：**
- `keyword` - 搜索关键词（可选，支持简拼、全拼、汉字）

**响应：**
```json
{
  "stations": [
    {
      "id": 1,
      "name": "北京",
      "code": "BJ",
      "pinyin": "beijing",
      "short_pinyin": "bj"
    }
  ]
}
```

#### POST /api/stations/validate
验证站点是否有效

**请求体：**
```json
{
  "stationName": "站点名称"
}
```

**响应：**
```json
{
  "valid": true,
  "station": {
    "id": 1,
    "name": "北京",
    "code": "BJ",
    "pinyin": "beijing",
    "short_pinyin": "bj"
  }
}
```

或

```json
{
  "valid": false,
  "error": "无法匹配该出发地/到达地",
  "suggestions": []
}
```

---

### 3.5 车次接口

#### POST /api/trains/search
搜索符合条件的车次列表

**请求体：**
```json
{
  "departureStation": "出发站",
  "arrivalStation": "到达站",
  "departureDate": "出发日期",
  "trainTypes": ["G", "D", "C"]  // 可选，车次类型筛选
}
```

**响应：**
```json
{
  "trains": [
    {
      "trainNo": "G103",
      "trainType": "高速动车组",
      "model": "CRH380A",
      "departureStation": "北京",
      "arrivalStation": "上海",
      "departureTime": "08:00",
      "arrivalTime": "12:30",
      "duration": 270,
      "departureDate": "2024-01-01",
      "availableSeats": {
        "商务座": 10,
        "一等座": 40,
        "二等座": 80
      }
    }
  ],
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

#### GET /api/trains/:trainNo
获取指定车次的详细信息

**响应：**
```json
{
  "trainNo": "G103",
  "trainType": "高速动车组",
  "model": "CRH380A",
  "route": {
    "origin": "北京",
    "destination": "上海",
    "distanceKm": 1318,
    "plannedDurationMin": 270,
    "departureTime": "08:00",
    "arrivalTime": "12:30"
  },
  "stops": [
    {
      "id": 1,
      "train_no": "G103",
      "seq": 1,
      "station": "北京",
      "arrive_time": null,
      "depart_time": "08:00",
      "stop_min": 0
    }
  ],
  "cars": [
    {
      "id": 1,
      "train_no": "G103",
      "car_no": 1,
      "seat_type": "商务座"
    }
  ],
  "fares": [
    {
      "id": 1,
      "train_no": "G103",
      "from_station": "北京",
      "to_station": "上海",
      "distance_km": 1318,
      "second_class_price": 553.0,
      "first_class_price": 933.0,
      "business_price": 1748.0
    }
  ],
  "availableSeats": {
    "商务座": 10,
    "一等座": 40,
    "二等座": 80
  }
}
```

#### POST /api/trains/available-seats
计算指定车次在指定区间的余票数

**请求体：**
```json
{
  "trainNo": "G103",
  "departureStation": "北京",
  "arrivalStation": "上海",
  "departureDate": "2024-01-01"
}
```

**响应：**
```json
{
  "trainNo": "G103",
  "availableSeats": {
    "商务座": 10,
    "一等座": 40,
    "二等座": 80
  }
}
```

#### GET /api/trains/filter-options
获取车次筛选选项

**查询参数：**
- `departureStation` - 出发站
- `arrivalStation` - 到达站
- `departureDate` - 出发日期

**响应：**
```json
{
  "departureStations": ["北京", "上海"],
  "arrivalStations": ["上海", "广州"],
  "seatTypes": ["商务座", "一等座", "二等座"]
}
```

#### GET /api/trains/available-dates
获取可选的出发日期列表

**响应：**
```json
{
  "availableDates": [
    "2024-01-01",
    "2024-01-02"
  ],
  "currentDate": "2024-01-01"
}
```

---

### 3.6 订单接口

#### GET /api/orders/new
获取订单填写页面信息

**认证：** 需要登录

**查询参数：**
- `trainNo` - 车次号
- `departureStation` - 出发站
- `arrivalStation` - 到达站
- `departureDate` - 出发日期

**响应：**
```json
{
  "trainInfo": {
    "trainNo": "G103",
    "departureStation": "北京",
    "arrivalStation": "上海",
    "departureDate": "2024-01-01"
  },
  "fareInfo": {
    "商务座": {
      "price": 1748.0,
      "available": 10
    },
    "一等座": {
      "price": 933.0,
      "available": 40
    },
    "二等座": {
      "price": 553.0,
      "available": 80
    }
  },
  "availableSeats": {
    "商务座": 10,
    "一等座": 40,
    "二等座": 80
  },
  "passengers": [
    {
      "id": "乘客ID",
      "name": "乘客姓名",
      "idCardType": "居民身份证",
      "idCardNumber": "证件号码（脱敏）",
      "discountType": "成人",
      "points": 0
    }
  ],
  "defaultSeatType": "二等座"
}
```

#### GET /api/orders/available-seat-types
获取有票席别列表（公开API，不需要登录）

**查询参数：**
- `trainNo` - 车次号
- `departureStation` - 出发站
- `arrivalStation` - 到达站
- `departureDate` - 出发日期

**响应：**
```json
{
  "seatTypes": [
    {
      "type": "商务座",
      "price": 1748.0,
      "available": 10
    },
    {
      "type": "一等座",
      "price": 933.0,
      "available": 40
    },
    {
      "type": "二等座",
      "price": 553.0,
      "available": 80
    }
  ]
}
```

#### POST /api/orders/submit
提交订单

**认证：** 需要登录

**请求体：**
```json
{
  "trainNo": "G103",
  "departureStation": "北京",
  "arrivalStation": "上海",
  "departureDate": "2024-01-01",
  "passengers": [
    {
      "passengerId": "乘客ID",
      "seatType": "二等座",
      "ticketType": "成人票"
    }
  ]
}
```

**响应：**
```json
{
  "message": "订单提交成功",
  "orderId": "订单ID",
  "orderDetails": {
    "trainInfo": {
      "trainNo": "G103",
      "departureStation": "北京",
      "arrivalStation": "上海",
      "departureDate": "2024-01-01"
    },
    "passengers": [
      {
        "passengerId": "乘客ID",
        "seatType": "二等座",
        "ticketType": "成人票"
      }
    ],
    "totalPrice": 553.0
  }
}
```

#### GET /api/orders/:orderId/confirmation
获取订单核对信息

**认证：** 需要登录

**响应：**
```json
{
  "trainInfo": {
    "trainNo": "G103",
    "departureStation": "北京",
    "arrivalStation": "上海",
    "departureDate": "2024-01-01",
    "departureTime": "08:00",
    "arrivalTime": "12:30"
  },
  "passengers": [
    {
      "sequence": 1,
      "seatType": "二等座",
      "ticketType": "成人票",
      "name": "乘客姓名",
      "idCardType": "居民身份证",
      "idCardNumber": "证件号码（脱敏）",
      "points": 0
    }
  ],
  "availableSeats": {
    "商务座": 10,
    "一等座": 40,
    "二等座": 80
  },
  "totalPrice": 553.0
}
```

#### POST /api/orders/:orderId/confirm
确认订单（分配座位并更新座位状态）

**认证：** 需要登录

**响应：**
```json
{
  "message": "购买成功",
  "orderId": "订单ID",
  "status": "completed",
  "trainInfo": {
    "trainNo": "G103",
    "departureStation": "北京",
    "arrivalStation": "上海",
    "departureDate": "2024-01-01",
    "departureTime": "08:00",
    "arrivalTime": "12:30"
  },
  "tickets": [
    {
      "passengerName": "乘客姓名",
      "seatType": "二等座",
      "seatNo": "1-01",
      "ticketType": "成人票"
    }
  ]
}
```

---

### 3.7 乘客接口

#### GET /api/passengers
获取用户乘客列表

**认证：** 需要登录

**响应：**
```json
{
  "passengers": [
    {
      "id": "乘客ID",
      "name": "乘客姓名",
      "idCardType": "居民身份证",
      "idCardNumber": "证件号码（脱敏）",
      "discountType": "成人",
      "points": 0
    }
  ]
}
```

#### POST /api/passengers/search
搜索乘客

**认证：** 需要登录

**请求体：**
```json
{
  "keyword": "搜索关键词"
}
```

**响应：**
```json
{
  "passengers": [
    {
      "id": "乘客ID",
      "name": "乘客姓名",
      "idCardType": "居民身份证",
      "idCardNumber": "证件号码（脱敏）",
      "discountType": "成人",
      "points": 0
    }
  ]
}
```

#### POST /api/passengers
添加乘客

**认证：** 需要登录

**请求体：**
```json
{
  "name": "乘客姓名",
  "idCardType": "居民身份证",
  "idCardNumber": "证件号码",
  "discountType": "成人"
}
```

**响应：**
```json
{
  "message": "添加乘客成功",
  "passengerId": "乘客ID",
  "points": 0
}
```

#### PUT /api/passengers/:passengerId
更新乘客信息

**认证：** 需要登录

**请求体：**
```json
{
  "name": "乘客姓名",
  "idCardType": "居民身份证",
  "idCardNumber": "证件号码",
  "discountType": "成人"
}
```

**响应：**
```json
{
  "message": "更新乘客信息成功",
  "passengerId": "乘客ID"
}
```

#### DELETE /api/passengers/:passengerId
删除乘客

**认证：** 需要登录

**响应：**
```json
{
  "message": "删除乘客成功"
}
```

#### GET /api/passengers/:passengerId
获取乘客详细信息

**认证：** 需要登录

**响应：**
```json
{
  "id": "乘客ID",
  "name": "乘客姓名",
  "idCardType": "居民身份证",
  "idCardNumber": "证件号码（脱敏）",
  "discountType": "成人",
  "points": 0
}
```

---

## 四、数据库初始化

### 4.1 初始化脚本

1. **车次数据初始化**
   ```bash
   cd backend
   node database/init-trains-data.js
   ```
   - 创建车次相关表
   - 从 `requirements/03-车次列表页/车次信息.json` 读取车次数据
   - 初始化站点信息
   - 插入车次基本信息、停靠站信息、车厢配置、票价信息
   - 初始化所有座位的状态为可用

2. **乘客和订单表初始化**
   ```bash
   cd backend
   node database/init-passengers-orders.js
   ```
   - 创建乘客表、订单表、订单明细表、座位锁定表
   - 创建相关索引

### 4.2 数据库文件位置

- **生产环境：** `backend/database/railway.db`
- **测试环境：** `backend/database/test.db`

---

## 五、核心业务逻辑

### 5.1 余票计算

**相邻两站：**
- 直接统计该区间内状态为 `available` 的座位数

**非相邻两站：**
- 只有座位在出发站到到达站的所有区间都是 `available` 状态时，才计入余票
- 如果某席别的所有座位在任一中间区间都被预订，则该席别余票数为0

### 5.2 票价计算

**相邻两站：**
- 直接使用该区间的票价

**非相邻两站：**
- 累加途经所有区间的票价
- 公式：某两站之间某席位票价 = 途经站点之间该席位票价之和

### 5.3 座位分配

**分配规则：**
1. 查询出发站到到达站的所有区间
2. 找到该席别所有座位
3. 检查每个座位在所有区间是否都是 `available`
4. 选择第一个在所有区间都是 `available` 的座位
5. 更新该座位在所有区间的状态为 `booked`
6. 更新订单明细中的座位号

### 5.4 订单流程

1. **提交订单**：创建订单和订单明细，状态为 `pending`
2. **确认订单**：分配座位，更新座位状态，订单状态变为 `completed`
3. **订单查询**：用户可以查询自己的订单列表和订单详情

---

## 六、数据安全

### 6.1 数据脱敏

- **手机号脱敏：** 格式 `(+86)158****9968`
- **证件号码脱敏：** 保留前4位和后2位，中间用星号替换

### 6.2 数据验证

- **姓名验证：** 长度3-30字符（汉字算2个字符）
- **证件号码验证：** 18位身份证号，只能包含数字和字母
- **邮箱验证：** 标准邮箱格式验证
- **手机号验证：** 11位数字

### 6.3 权限控制

- 用户只能访问自己的订单和乘客信息
- 订单确认时需要验证用户权限
- 乘客信息修改和删除需要验证用户权限

---

## 七、总结

### 7.1 数据库特点

1. **使用SQLite**：轻量级，适合中小型应用
2. **表结构清晰**：用户、乘客、车次、订单模块分离
3. **索引优化**：关键字段建立索引，提高查询性能
4. **外键约束**：保证数据完整性

### 7.2 API特点

1. **RESTful风格**：遵循RESTful设计原则
2. **认证机制**：使用JWT令牌进行用户认证
3. **错误处理**：统一的错误响应格式
4. **数据验证**：请求参数验证和数据格式验证

### 7.3 业务逻辑

1. **余票计算**：支持跨区间余票计算
2. **票价计算**：支持跨区间票价累加
3. **座位分配**：自动分配可用座位
4. **订单管理**：完整的订单生命周期管理

---

## 八、注意事项

1. **数据库文件**：生产环境需要定期备份数据库文件
2. **座位状态**：座位状态表数据量较大，需要优化查询性能
3. **并发控制**：座位分配需要考虑并发情况，避免超卖
4. **数据一致性**：订单和座位状态需要保持一致
5. **索引维护**：定期检查和优化索引性能

---

**文档生成时间：** 2024-01-01
**数据库版本：** SQLite 3
**API版本：** v1.0

