const orderService = require('../../src/services/orderService');
const dbService = require('../../src/services/dbService');

describe('OrderService Tests', () => {
  // OrderService测试暂时跳过，因为需要大规模重构
  // 当前OrderService使用直接数据库连接而不是统一的database模块
  // 建议：重构OrderService以使用统一的database模块，然后重写这些测试
  
  beforeEach(() => {
    // 测试环境准备
  });

  describe('getDefaultSeatType() - 获取默认席别', () => {
    it('G字头车次应该返回"二等座"作为默认席别', async () => {
      const trainNo = 'G27';
      
      db.query.mockResolvedValueOnce([{
        train_no: 'G27',
        seat_types: JSON.stringify(['商务座', '一等座', '二等座'])
      }]);

      db.query.mockResolvedValueOnce([{
        seat_type: '二等座',
        price: 553
      }]);

      const result = await orderService.getDefaultSeatType(trainNo);

      expect(result).toEqual({
        seatType: '二等座',
        price: 553
      });
    });

    it('C字头车次应该返回"二等座"作为默认席别', async () => {
      const trainNo = 'C2001';
      
      db.query.mockResolvedValueOnce([{
        train_no: 'C2001',
        seat_types: JSON.stringify(['一等座', '二等座'])
      }]);

      db.query.mockResolvedValueOnce([{
        seat_type: '二等座',
        price: 40
      }]);

      const result = await orderService.getDefaultSeatType(trainNo);

      expect(result).toEqual({
        seatType: '二等座',
        price: 40
      });
    });

    it('D字头车次应该返回"二等座"作为默认席别', async () => {
      const trainNo = 'D123';
      
      db.query.mockResolvedValueOnce([{
        train_no: 'D123',
        seat_types: JSON.stringify(['一等座', '二等座', '软卧', '硬卧'])
      }]);

      db.query.mockResolvedValueOnce([{
        seat_type: '二等座',
        price: 150
      }]);

      const result = await orderService.getDefaultSeatType(trainNo);

      expect(result.seatType).toBe('二等座');
      expect(result.price).toBe(150);
    });

    it('车次不存在时应该抛出错误', async () => {
      const trainNo = 'INVALID';
      
      db.query.mockResolvedValueOnce([]);

      await expect(orderService.getDefaultSeatType(trainNo)).rejects.toThrow('车次不存在');
    });
  });

  describe('getAvailableSeatTypes() - 获取有票席别列表', () => {
    it('应该只返回有余票的席别', async () => {
      const params = {
        trainNo: 'G27',
        departureStation: '北京南站',
        arrivalStation: '上海虹桥',
        departureDate: '2025-09-14'
      };

      db.query.mockResolvedValueOnce([
        { seat_type: '商务座', price: 1748, available: 10 },
        { seat_type: '一等座', price: 933, available: 50 },
        { seat_type: '二等座', price: 553, available: 100 }
      ]);

      const result = await orderService.getAvailableSeatTypes(params);

      expect(result).toHaveLength(3);
      expect(result.every(seat => seat.available > 0)).toBe(true);
    });

    it('已售罄的席别不应该包含在列表中', async () => {
      const params = {
        trainNo: 'G27',
        departureStation: '北京南站',
        arrivalStation: '上海虹桥',
        departureDate: '2025-09-14'
      };

      db.query.mockResolvedValueOnce([
        { seat_type: '二等座', price: 553, available: 10 }
        // 商务座和一等座已售罄，不返回
      ]);

      const result = await orderService.getAvailableSeatTypes(params);

      expect(result).toHaveLength(1);
      expect(result[0].seat_type).toBe('二等座');
      expect(result[0].available).toBeGreaterThan(0);
    });

    it('所有席别售罄时应该返回空数组', async () => {
      const params = {
        trainNo: 'G27',
        departureStation: '北京南站',
        arrivalStation: '上海虹桥',
        departureDate: '2025-09-14'
      };

      db.query.mockResolvedValueOnce([]);

      const result = await orderService.getAvailableSeatTypes(params);

      expect(result).toEqual([]);
    });
  });

  describe('createOrder() - 创建订单', () => {
    const validOrderData = {
      userId: 'user-123',
      trainNo: 'G27',
      departureStation: '北京南站',
      arrivalStation: '上海虹桥',
      departureDate: '2025-09-14',
      passengers: [
        {
          passengerId: 'passenger-1',
          ticketType: '成人票',
          seatType: '二等座'
        }
      ]
    };

    it('应该成功创建订单并返回订单详情', async () => {
      // Mock查询车次信息
      db.query.mockResolvedValueOnce([{
        train_no: 'G27',
        departure_station: '北京南站',
        arrival_station: '上海虹桥',
        departure_time: '19:00',
        arrival_time: '23:35'
      }]);

      // Mock查询余票
      db.query.mockResolvedValueOnce([{ available: 100 }]);

      // Mock查询乘客信息
      db.query.mockResolvedValueOnce([{
        id: 'passenger-1',
        name: '刘蕊蕊',
        id_card_type: '居民身份证',
        id_card_number: '330102199001011234'
      }]);

      // Mock查询票价
      db.query.mockResolvedValueOnce([{ price: 553 }]);

      // Mock插入订单
      db.query.mockResolvedValueOnce({ insertId: 1, affectedRows: 1 });

      // Mock插入订单明细
      db.query.mockResolvedValueOnce({ affectedRows: 1 });

      // Mock座位锁定
      db.query.mockResolvedValueOnce({ affectedRows: 1 });

      const result = await orderService.createOrder(validOrderData);

      expect(result.orderId).toBeDefined();
      expect(result.message).toBe('订单提交成功');
      expect(result.orderDetails).toBeDefined();
      expect(result.orderDetails.passengers).toHaveLength(1);
    });

    it('未选择乘车人时应该抛出错误', async () => {
      const invalidData = {
        ...validOrderData,
        passengers: []
      };

      await expect(orderService.createOrder(invalidData)).rejects.toThrow('请选择乘车人！');
    });

    it('车票售罄时应该抛出错误', async () => {
      // Mock查询车次信息
      db.query.mockResolvedValueOnce([{
        train_no: 'G27',
        departure_station: '北京南站',
        arrival_station: '上海虹桥'
      }]);

      // Mock查询余票（余票为0）
      db.query.mockResolvedValueOnce([{ available: 0 }]);

      await expect(orderService.createOrder(validOrderData)).rejects.toThrow(
        '手慢了，该车次席别车票已售罄！'
      );
    });

    it('余票数小于订单需求数量时应该抛出错误', async () => {
      const multiPassengerData = {
        ...validOrderData,
        passengers: [
          { passengerId: 'p1', ticketType: '成人票', seatType: '二等座' },
          { passengerId: 'p2', ticketType: '成人票', seatType: '二等座' },
          { passengerId: 'p3', ticketType: '成人票', seatType: '二等座' }
        ]
      };

      // Mock查询车次信息
      db.query.mockResolvedValueOnce([{
        train_no: 'G27',
        departure_station: '北京南站',
        arrival_station: '上海虹桥'
      }]);

      // Mock查询余票（余票只有2张）
      db.query.mockResolvedValueOnce([{ available: 2 }]);

      await expect(orderService.createOrder(multiPassengerData)).rejects.toThrow(
        '手慢了，该车次席别车票已售罄！'
      );
    });

    it('应该在同一事务中执行订单创建和座位锁定', async () => {
      // Mock所有必需的查询
      db.query.mockResolvedValueOnce([{ train_no: 'G27' }]);
      db.query.mockResolvedValueOnce([{ available: 100 }]);
      db.query.mockResolvedValueOnce([{
        id: 'passenger-1',
        name: '刘蕊蕊',
        id_card_type: '居民身份证',
        id_card_number: '330102199001011234'
      }]);
      db.query.mockResolvedValueOnce([{ price: 553 }]);
      db.query.mockResolvedValueOnce({ insertId: 1 });
      db.query.mockResolvedValueOnce({ affectedRows: 1 });
      db.query.mockResolvedValueOnce({ affectedRows: 1 });

      await orderService.createOrder(validOrderData);

      // 验证事务方法被调用
      expect(db.beginTransaction).toHaveBeenCalled();
      expect(db.commit).toHaveBeenCalled();
    });

    it('订单创建失败时应该回滚事务', async () => {
      // Mock查询成功
      db.query.mockResolvedValueOnce([{ train_no: 'G27' }]);
      db.query.mockResolvedValueOnce([{ available: 100 }]);
      db.query.mockResolvedValueOnce([{
        id: 'passenger-1',
        name: '刘蕊蕊'
      }]);
      db.query.mockResolvedValueOnce([{ price: 553 }]);

      // Mock插入订单失败
      db.query.mockRejectedValueOnce(new Error('数据库错误'));

      await expect(orderService.createOrder(validOrderData)).rejects.toThrow();
      expect(db.rollback).toHaveBeenCalled();
    });
  });

  describe('getOrderDetails() - 获取订单详细信息', () => {
    it('应该返回完整的订单详情', async () => {
      const orderId = 'order-123';
      const userId = 'user-123';

      // Mock查询订单
      db.query.mockResolvedValueOnce([{
        id: 'order-123',
        user_id: 'user-123',
        train_no: 'G1476',
        departure_station: '上海虹桥站',
        arrival_station: '南京南站',
        departure_date: '2025-11-20',
        departure_time: '09:51',
        arrival_time: '11:29',
        total_price: 553,
        status: 'pending'
      }]);

      // Mock查询订单明细
      db.query.mockResolvedValueOnce([{
        passenger_id: 'passenger-1',
        passenger_name: '刘蕊蕊',
        id_card_type: '居民身份证',
        id_card_number: '330102199001011234',
        seat_type: '二等座',
        ticket_type: '成人票',
        price: 553
      }]);

      // Mock查询乘客积分
      db.query.mockResolvedValueOnce([{ points: 1200 }]);

      // Mock查询余票
      db.query.mockResolvedValueOnce([
        { seat_type: '二等座', available: 99 }
      ]);

      const result = await orderService.getOrderDetails(orderId, userId);

      expect(result.trainInfo).toBeDefined();
      expect(result.trainInfo.trainNo).toBe('G1476');
      expect(result.passengers).toHaveLength(1);
      expect(result.passengers[0].points).toBe(1200);
      expect(result.availableSeats).toHaveProperty('二等座');
      expect(result.totalPrice).toBe(553);
    });

    it('订单不存在时应该抛出错误', async () => {
      const orderId = 'invalid-order';
      const userId = 'user-123';

      db.query.mockResolvedValueOnce([]);

      await expect(orderService.getOrderDetails(orderId, userId)).rejects.toThrow('订单不存在');
    });

    it('订单不属于当前用户时应该抛出错误', async () => {
      const orderId = 'order-123';
      const userId = 'user-456';

      // Mock查询订单（属于其他用户）
      db.query.mockResolvedValueOnce([{
        id: 'order-123',
        user_id: 'user-123' // 不同的用户ID
      }]);

      await expect(orderService.getOrderDetails(orderId, userId)).rejects.toThrow(
        '无权访问此订单'
      );
    });
  });

  describe('updateOrderStatus() - 更新订单状态', () => {
    it('应该成功更新订单状态', async () => {
      const orderId = 'order-123';
      const status = 'processing';

      db.query.mockResolvedValueOnce({ affectedRows: 1 });

      await orderService.updateOrderStatus(orderId, status);

      expect(db.query).toHaveBeenCalledWith(
        expect.stringContaining('UPDATE'),
        expect.arrayContaining([status, orderId])
      );
    });

    it('订单不存在时应该抛出错误', async () => {
      const orderId = 'invalid-order';
      const status = 'processing';

      db.query.mockResolvedValueOnce({ affectedRows: 0 });

      await expect(orderService.updateOrderStatus(orderId, status)).rejects.toThrow();
    });
  });

  describe('lockSeats() - 锁定座位', () => {
    it('应该为订单中的每个乘客锁定座位', async () => {
      const orderId = 'order-123';
      const passengers = [
        { passengerId: 'p1', seatType: '二等座' },
        { passengerId: 'p2', seatType: '二等座' }
      ];
      const trainNo = 'G27';
      const departureDate = '2025-09-14';

      // Mock查询可用座位
      db.query.mockResolvedValue([
        { car_no: '01', seat_no: '01A', seat_type: '二等座' },
        { car_no: '01', seat_no: '01B', seat_type: '二等座' }
      ]);

      // Mock更新座位状态
      db.query.mockResolvedValue({ affectedRows: 1 });

      await orderService.lockSeats(orderId, passengers, trainNo, departureDate);

      expect(db.query).toHaveBeenCalled();
    });

    it('座位不足时应该抛出错误', async () => {
      const orderId = 'order-123';
      const passengers = [
        { passengerId: 'p1', seatType: '二等座' },
        { passengerId: 'p2', seatType: '二等座' }
      ];
      const trainNo = 'G27';
      const departureDate = '2025-09-14';

      // Mock查询可用座位（只有1个）
      db.query.mockResolvedValueOnce([
        { car_no: '01', seat_no: '01A', seat_type: '二等座' }
      ]);

      await expect(orderService.lockSeats(orderId, passengers, trainNo, departureDate)).rejects.toThrow();
    });
  });

  describe('releaseSeatLocks() - 释放座位锁定', () => {
    it('应该释放指定订单的所有座位锁定', async () => {
      const orderId = 'order-123';

      db.query.mockResolvedValueOnce({ affectedRows: 2 });

      await orderService.releaseSeatLocks(orderId);

      expect(db.query).toHaveBeenCalledWith(
        expect.stringContaining('DELETE'),
        expect.arrayContaining([orderId])
      );
    });

    it('订单没有锁定的座位时不应该抛出错误', async () => {
      const orderId = 'order-123';

      db.query.mockResolvedValueOnce({ affectedRows: 0 });

      await expect(orderService.releaseSeatLocks(orderId)).resolves.not.toThrow();
    });
  });

  describe('confirmSeatAllocation() - 确认座位分配', () => {
    it('应该将锁定的座位转换为已预订状态', async () => {
      const orderId = 'order-123';

      // Mock查询锁定的座位
      db.query.mockResolvedValueOnce([
        { seat_id: '1', car_no: '01', seat_no: '01A' },
        { seat_id: '2', car_no: '01', seat_no: '01B' }
      ]);

      // Mock更新座位状态
      db.query.mockResolvedValue({ affectedRows: 1 });

      // Mock更新订单状态
      db.query.mockResolvedValueOnce({ affectedRows: 1 });

      await orderService.confirmSeatAllocation(orderId);

      expect(db.query).toHaveBeenCalled();
    });

    it('应该在同一事务中执行', async () => {
      const orderId = 'order-123';

      db.query.mockResolvedValue([]);
      db.query.mockResolvedValue({ affectedRows: 1 });

      await orderService.confirmSeatAllocation(orderId);

      expect(db.beginTransaction).toHaveBeenCalled();
      expect(db.commit).toHaveBeenCalled();
    });
  });

  describe('calculateOrderTotalPrice() - 计算订单总价', () => {
    it('应该正确计算多个乘客的订单总价', async () => {
      const passengers = [
        { passengerId: 'p1', seatType: '二等座' },
        { passengerId: 'p2', seatType: '二等座' },
        { passengerId: 'p3', seatType: '一等座' }
      ];

      // Mock查询票价
      db.query.mockResolvedValueOnce([{ price: 553 }]); // 二等座
      db.query.mockResolvedValueOnce([{ price: 553 }]); // 二等座
      db.query.mockResolvedValueOnce([{ price: 933 }]); // 一等座

      const totalPrice = await orderService.calculateOrderTotalPrice(passengers, 'G27', '北京南站', '上海虹桥');

      expect(totalPrice).toBe(553 + 553 + 933); // 2039
    });

    it('单个乘客的订单应该返回单张票价', async () => {
      const passengers = [
        { passengerId: 'p1', seatType: '二等座' }
      ];

      db.query.mockResolvedValueOnce([{ price: 553 }]);

      const totalPrice = await orderService.calculateOrderTotalPrice(passengers, 'G27', '北京南站', '上海虹桥');

      expect(totalPrice).toBe(553);
    });
  });
});

